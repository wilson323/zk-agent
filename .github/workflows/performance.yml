# æ€§èƒ½ç›‘æ§å’Œä¼˜åŒ–å·¥ä½œæµ
# ä¸“é—¨ç”¨äºåº”ç”¨æ€§èƒ½æµ‹è¯•ã€ç›‘æ§å’Œä¼˜åŒ–å»ºè®®

name: Performance Monitoring

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # æ¯å‘¨æ—¥å‡Œæ™¨3ç‚¹è¿è¡Œå®Œæ•´æ€§èƒ½æµ‹è¯•
    - cron: '0 3 * * 0'
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Performance test type'
        required: true
        default: 'full'
        type: choice
        options:
          - 'full'
          - 'lighthouse'
          - 'load'
          - 'bundle'

env:
  NODE_VERSION: '20'
  LIGHTHOUSE_CI_TOKEN: ${{ secrets.LIGHTHOUSE_CI_TOKEN }}

jobs:
  # Bundle åˆ†æ
  bundle-analysis:
    name: Bundle Analysis
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'full' || github.event.inputs.test_type == 'bundle' || github.event.inputs.test_type == ''
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma client
        run: npm run db:generate

      - name: Build application
        run: npm run build
        env:
          ANALYZE: true

      - name: Analyze bundle size
        run: |
          echo "## ğŸ“¦ Bundle åˆ†æç»“æœ" >> $GITHUB_STEP_SUMMARY
          
          # è·å–æ€»ä½“ç§¯
          TOTAL_SIZE=$(du -sh .next/static | cut -f1)
          echo "- **æ€»ä½“ç§¯**: $TOTAL_SIZE" >> $GITHUB_STEP_SUMMARY
          
          # åˆ†æå„ä¸ªchunk
          echo "\n### ä¸»è¦æ–‡ä»¶å¤§å°" >> $GITHUB_STEP_SUMMARY
          find .next/static -name "*.js" -type f -exec du -h {} + | sort -hr | head -10 | \
          while read size file; do
            echo "- \`$(basename $file)\`: $size" >> $GITHUB_STEP_SUMMARY
          done

      - name: Check bundle size limits
        run: |
          # æ£€æŸ¥ä¸»bundleæ˜¯å¦è¶…è¿‡é™åˆ¶
          MAIN_BUNDLE_SIZE=$(find .next/static -name "*main*.js" -exec stat -c%s {} + | awk '{sum+=$1} END {print sum}')
          MAX_SIZE=1048576  # 1MB in bytes
          
          if [ $MAIN_BUNDLE_SIZE -gt $MAX_SIZE ]; then
            echo "âŒ Main bundle size ($MAIN_BUNDLE_SIZE bytes) exceeds limit ($MAX_SIZE bytes)"
            exit 1
          else
            echo "âœ… Main bundle size is within limits"
          fi

      - name: Upload bundle analysis
        uses: actions/upload-artifact@v4
        with:
          name: bundle-analysis
          path: |
            .next/analyze/
            .next/static/
          retention-days: 30

  # Lighthouse CI æ€§èƒ½æµ‹è¯•
  lighthouse:
    name: Lighthouse Performance
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'full' || github.event.inputs.test_type == 'lighthouse' || github.event.inputs.test_type == ''
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: zkagent_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup test environment
        run: |
          cp .env.example .env.local
          echo "DATABASE_URL=postgresql://postgres:postgres@localhost:5432/zkagent_test" >> .env.local
          echo "REDIS_URL=redis://localhost:6379" >> .env.local
          echo "NEXTAUTH_SECRET=test-secret-key-for-lighthouse" >> .env.local
          echo "NEXTAUTH_URL=http://localhost:3000" >> .env.local

      - name: Generate Prisma client
        run: npm run db:generate

      - name: Run database migrations
        run: npm run db:migrate
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/zkagent_test

      - name: Build application
        run: npm run build

      - name: Start application
        run: |
          npm start &
          sleep 30
          curl -f http://localhost:3000 || exit 1
        env:
          PORT: 3000

      - name: Run Lighthouse CI
        run: |
          npm install -g @lhci/cli
          lhci autorun
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
          LHCI_TOKEN: ${{ secrets.LIGHTHOUSE_CI_TOKEN }}

      - name: Upload Lighthouse reports
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-reports
          path: .lighthouseci/
          retention-days: 30

  # è´Ÿè½½æµ‹è¯•
  load-testing:
    name: Load Testing
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'full' || github.event.inputs.test_type == 'load' || github.event.inputs.test_type == ''
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: zkagent_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Setup test environment
        run: |
          cp .env.example .env.local
          echo "DATABASE_URL=postgresql://postgres:postgres@localhost:5432/zkagent_test" >> .env.local
          echo "REDIS_URL=redis://localhost:6379" >> .env.local
          echo "NEXTAUTH_SECRET=test-secret-key-for-load-test" >> .env.local
          echo "NEXTAUTH_URL=http://localhost:3000" >> .env.local

      - name: Generate Prisma client
        run: npm run db:generate

      - name: Run database migrations
        run: npm run db:migrate
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/zkagent_test

      - name: Build and start application
        run: |
          npm run build
          npm start &
          sleep 30
          curl -f http://localhost:3000 || exit 1
        env:
          PORT: 3000

      - name: Create k6 test script
        run: |
          cat > load-test.js << 'EOF'
          import http from 'k6/http';
          import { check, sleep } from 'k6';
          import { Rate } from 'k6/metrics';
          
          export let errorRate = new Rate('errors');
          
          export let options = {
            stages: [
              { duration: '2m', target: 10 }, // é¢„çƒ­
              { duration: '5m', target: 50 }, // æ­£å¸¸è´Ÿè½½
              { duration: '2m', target: 100 }, // å³°å€¼è´Ÿè½½
              { duration: '5m', target: 50 }, // å›è½
              { duration: '2m', target: 0 }, // å†·å´
            ],
            thresholds: {
              http_req_duration: ['p(95)<2000'], // 95%è¯·æ±‚åœ¨2ç§’å†…å®Œæˆ
              http_req_failed: ['rate<0.1'], // é”™è¯¯ç‡ä½äº10%
              errors: ['rate<0.1'],
            },
          };
          
          export default function() {
            // æµ‹è¯•ä¸»é¡µ
            let response = http.get('http://localhost:3000');
            check(response, {
              'status is 200': (r) => r.status === 200,
              'response time < 2s': (r) => r.timings.duration < 2000,
            }) || errorRate.add(1);
            
            sleep(1);
            
            // æµ‹è¯•APIç«¯ç‚¹
            response = http.get('http://localhost:3000/api/health');
            check(response, {
              'API status is 200': (r) => r.status === 200,
              'API response time < 1s': (r) => r.timings.duration < 1000,
            }) || errorRate.add(1);
            
            sleep(1);
          }
          EOF

      - name: Run load test
        run: k6 run load-test.js --out json=load-test-results.json

      - name: Analyze load test results
        run: |
          echo "## ğŸš€ è´Ÿè½½æµ‹è¯•ç»“æœ" >> $GITHUB_STEP_SUMMARY
          
          # æå–å…³é”®æŒ‡æ ‡
          AVG_RESPONSE_TIME=$(cat load-test-results.json | jq -r '.metrics.http_req_duration.values.avg')
          P95_RESPONSE_TIME=$(cat load-test-results.json | jq -r '.metrics.http_req_duration.values."p(95)"')
          ERROR_RATE=$(cat load-test-results.json | jq -r '.metrics.http_req_failed.values.rate')
          
          echo "- **å¹³å‡å“åº”æ—¶é—´**: ${AVG_RESPONSE_TIME}ms" >> $GITHUB_STEP_SUMMARY
          echo "- **95%å“åº”æ—¶é—´**: ${P95_RESPONSE_TIME}ms" >> $GITHUB_STEP_SUMMARY
          echo "- **é”™è¯¯ç‡**: $(echo "$ERROR_RATE * 100" | bc -l)%" >> $GITHUB_STEP_SUMMARY
          
          # æ£€æŸ¥æ˜¯å¦é€šè¿‡é˜ˆå€¼
          if (( $(echo "$P95_RESPONSE_TIME > 2000" | bc -l) )); then
            echo "âŒ P95å“åº”æ—¶é—´è¶…è¿‡2ç§’é˜ˆå€¼" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… P95å“åº”æ—¶é—´åœ¨é˜ˆå€¼å†…" >> $GITHUB_STEP_SUMMARY
          fi
          
          if (( $(echo "$ERROR_RATE > 0.1" | bc -l) )); then
            echo "âŒ é”™è¯¯ç‡è¶…è¿‡10%é˜ˆå€¼" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… é”™è¯¯ç‡åœ¨é˜ˆå€¼å†…" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload load test results
        uses: actions/upload-artifact@v4
        with:
          name: load-test-results
          path: load-test-results.json
          retention-days: 30

  # å†…å­˜å’ŒCPUæ€§èƒ½åˆ†æ
  profiling:
    name: Performance Profiling
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'full' || github.event.inputs.test_type == ''
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install profiling tools
        run: |
          npm install -g clinic
          npm install --save-dev @types/node

      - name: Generate Prisma client
        run: npm run db:generate

      - name: Build application
        run: npm run build

      - name: Create profiling script
        run: |
          cat > profile-test.js << 'EOF'
          const { spawn } = require('child_process');
          const http = require('http');
          
          // å¯åŠ¨åº”ç”¨
          const app = spawn('npm', ['start'], {
            env: { ...process.env, PORT: '3000' }
          });
          
          // ç­‰å¾…åº”ç”¨å¯åŠ¨
          setTimeout(() => {
            // å‘é€ä¸€äº›è¯·æ±‚æ¥è§¦å‘æ€§èƒ½åˆ†æ
            for (let i = 0; i < 100; i++) {
              http.get('http://localhost:3000', (res) => {
                res.on('data', () => {});
                res.on('end', () => {});
              });
            }
            
            // 10ç§’ååœæ­¢åº”ç”¨
            setTimeout(() => {
              app.kill('SIGTERM');
              process.exit(0);
            }, 10000);
          }, 5000);
          EOF

      - name: Run CPU profiling
        run: |
          timeout 60s clinic doctor -- node profile-test.js || true
          ls -la .clinic/
        continue-on-error: true

      - name: Upload profiling results
        uses: actions/upload-artifact@v4
        with:
          name: profiling-results
          path: .clinic/
          retention-days: 30
        if: always()

  # æ€§èƒ½å›å½’æ£€æµ‹
  performance-regression:
    name: Performance Regression
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build PR version
        run: npm run build

      - name: Measure PR bundle size
        run: |
          PR_SIZE=$(du -sb .next/static | cut -f1)
          echo "PR_BUNDLE_SIZE=$PR_SIZE" >> $GITHUB_ENV

      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}

      - name: Install base dependencies
        run: npm ci

      - name: Build base version
        run: npm run build

      - name: Measure base bundle size
        run: |
          BASE_SIZE=$(du -sb .next/static | cut -f1)
          echo "BASE_BUNDLE_SIZE=$BASE_SIZE" >> $GITHUB_ENV

      - name: Compare performance
        run: |
          DIFF=$(($PR_BUNDLE_SIZE - $BASE_BUNDLE_SIZE))
          PERCENT_CHANGE=$(echo "scale=2; $DIFF * 100 / $BASE_BUNDLE_SIZE" | bc -l)
          
          echo "## ğŸ“Š æ€§èƒ½å›å½’åˆ†æ" >> $GITHUB_STEP_SUMMARY
          echo "- **åŸºç¡€ç‰ˆæœ¬Bundleå¤§å°**: $(numfmt --to=iec $BASE_BUNDLE_SIZE)" >> $GITHUB_STEP_SUMMARY
          echo "- **PRç‰ˆæœ¬Bundleå¤§å°**: $(numfmt --to=iec $PR_BUNDLE_SIZE)" >> $GITHUB_STEP_SUMMARY
          echo "- **å¤§å°å˜åŒ–**: $(numfmt --to=iec $DIFF) (${PERCENT_CHANGE}%)" >> $GITHUB_STEP_SUMMARY
          
          if [ $DIFF -gt 102400 ]; then  # 100KBå¢é•¿é˜ˆå€¼
            echo "âŒ Bundleå¤§å°å¢é•¿è¶…è¿‡100KBï¼Œå¯èƒ½å­˜åœ¨æ€§èƒ½å›å½’" >> $GITHUB_STEP_SUMMARY
            exit 1
          elif [ $DIFF -gt 51200 ]; then  # 50KBè­¦å‘Šé˜ˆå€¼
            echo "âš ï¸ Bundleå¤§å°å¢é•¿è¶…è¿‡50KBï¼Œè¯·æ³¨æ„" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Bundleå¤§å°å˜åŒ–åœ¨å¯æ¥å—èŒƒå›´å†…" >> $GITHUB_STEP_SUMMARY
          fi

  # æ€§èƒ½æŠ¥å‘Šæ±‡æ€»
  performance-summary:
    name: Performance Summary
    runs-on: ubuntu-latest
    needs: [bundle-analysis, lighthouse, load-testing, profiling]
    if: always()
    steps:
      - name: Generate performance summary
        run: |
          echo "## ğŸ¯ æ€§èƒ½æµ‹è¯•æ±‡æ€»" >> $GITHUB_STEP_SUMMARY
          echo "| æµ‹è¯•é¡¹ | çŠ¶æ€ | è¯´æ˜ |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Bundleåˆ†æ | ${{ needs.bundle-analysis.result == 'success' && 'âœ…' || needs.bundle-analysis.result == 'skipped' && 'â­ï¸' || 'âŒ' }} | Bundleå¤§å°å’Œç»„æˆåˆ†æ |" >> $GITHUB_STEP_SUMMARY
          echo "| Lighthouse | ${{ needs.lighthouse.result == 'success' && 'âœ…' || needs.lighthouse.result == 'skipped' && 'â­ï¸' || 'âŒ' }} | é¡µé¢æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒ |" >> $GITHUB_STEP_SUMMARY
          echo "| è´Ÿè½½æµ‹è¯• | ${{ needs.load-testing.result == 'success' && 'âœ…' || needs.load-testing.result == 'skipped' && 'â­ï¸' || 'âŒ' }} | å¹¶å‘ç”¨æˆ·è´Ÿè½½èƒ½åŠ› |" >> $GITHUB_STEP_SUMMARY
          echo "| æ€§èƒ½åˆ†æ | ${{ needs.profiling.result == 'success' && 'âœ…' || needs.profiling.result == 'skipped' && 'â­ï¸' || 'âŒ' }} | CPUå’Œå†…å­˜ä½¿ç”¨åˆ†æ |" >> $GITHUB_STEP_SUMMARY
          
          echo "\n### ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®" >> $GITHUB_STEP_SUMMARY
          echo "- å®šæœŸç›‘æ§Bundleå¤§å°ï¼Œé¿å…ä¸å¿…è¦çš„ä¾èµ–" >> $GITHUB_STEP_SUMMARY
          echo "- ä½¿ç”¨ä»£ç åˆ†å‰²å’Œæ‡’åŠ è½½ä¼˜åŒ–é¦–å±åŠ è½½" >> $GITHUB_STEP_SUMMARY
          echo "- ä¼˜åŒ–å›¾ç‰‡å’Œé™æ€èµ„æºçš„åŠ è½½ç­–ç•¥" >> $GITHUB_STEP_SUMMARY
          echo "- å®æ–½æœ‰æ•ˆçš„ç¼“å­˜ç­–ç•¥" >> $GITHUB_STEP_SUMMARY
          echo "- ç›‘æ§å’Œä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½" >> $GITHUB_STEP_SUMMARY

      - name: Notify performance results
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/github-script@v7
        with:
          script: |
            const results = {
              bundle: '${{ needs.bundle-analysis.result }}',
              lighthouse: '${{ needs.lighthouse.result }}',
              load: '${{ needs.load-testing.result }}',
              profiling: '${{ needs.profiling.result }}'
            };
            
            const passed = Object.values(results).filter(r => r === 'success').length;
            const total = Object.values(results).filter(r => r !== 'skipped').length;
            
            console.log(`Performance tests completed: ${passed}/${total} passed`);