# éƒ¨ç½²å·¥ä½œæµ
# æ”¯æŒå¼€å‘ã€æµ‹è¯•ã€é¢„ç”Ÿäº§å’Œç”Ÿäº§çŽ¯å¢ƒçš„è‡ªåŠ¨åŒ–éƒ¨ç½²

name: Deploy Application

on:
  push:
    branches:
      - main        # ç”Ÿäº§çŽ¯å¢ƒ
      - develop     # å¼€å‘çŽ¯å¢ƒ
      - staging     # é¢„ç”Ÿäº§çŽ¯å¢ƒ
    tags:
      - 'v*'        # ç‰ˆæœ¬æ ‡ç­¾éƒ¨ç½²
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'development'
        type: choice
        options:
          - 'development'
          - 'staging'
          - 'production'
      version:
        description: 'Version to deploy (optional)'
        required: false
        type: string
      force_deploy:
        description: 'Force deployment even if tests fail'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '20'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ç¡®å®šéƒ¨ç½²çŽ¯å¢ƒ
  determine-environment:
    name: Determine Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      should_deploy: ${{ steps.env.outputs.should_deploy }}
      version: ${{ steps.env.outputs.version }}
    steps:
      - name: Determine deployment environment
        id: env
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ENVIRONMENT="${{ github.event.inputs.environment }}"
            VERSION="${{ github.event.inputs.version || github.sha }}"
            SHOULD_DEPLOY="true"
          elif [ "${{ github.ref_type }}" = "tag" ]; then
            ENVIRONMENT="production"
            VERSION="${{ github.ref_name }}"
            SHOULD_DEPLOY="true"
          elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
            ENVIRONMENT="production"
            VERSION="${{ github.sha }}"
            SHOULD_DEPLOY="true"
          elif [ "${{ github.ref }}" = "refs/heads/staging" ]; then
            ENVIRONMENT="staging"
            VERSION="${{ github.sha }}"
            SHOULD_DEPLOY="true"
          elif [ "${{ github.ref }}" = "refs/heads/develop" ]; then
            ENVIRONMENT="development"
            VERSION="${{ github.sha }}"
            SHOULD_DEPLOY="true"
          else
            ENVIRONMENT="none"
            VERSION="${{ github.sha }}"
            SHOULD_DEPLOY="false"
          fi
          
          echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "should_deploy=$SHOULD_DEPLOY" >> $GITHUB_OUTPUT
          
          echo "ðŸŽ¯ éƒ¨ç½²çŽ¯å¢ƒ: $ENVIRONMENT" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ éƒ¨ç½²ç‰ˆæœ¬: $VERSION" >> $GITHUB_STEP_SUMMARY

  # é¢„éƒ¨ç½²æ£€æŸ¥
  pre-deployment-checks:
    name: Pre-deployment Checks
    runs-on: ubuntu-latest
    needs: determine-environment
    if: needs.determine-environment.outputs.should_deploy == 'true'
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: zkagent_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup test environment
        run: |
          cp .env.example .env.test
          echo "DATABASE_URL=postgresql://postgres:postgres@localhost:5432/zkagent_test" >> .env.test
          echo "REDIS_URL=redis://localhost:6379" >> .env.test

      - name: Generate Prisma client
        run: npm run db:generate

      - name: Run database migrations
        run: npm run db:migrate
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/zkagent_test

      - name: Run tests
        run: npm run test:ci
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/zkagent_test
          REDIS_URL: redis://localhost:6379
        continue-on-error: ${{ github.event.inputs.force_deploy == 'true' }}

      - name: Run linting
        run: npm run lint
        continue-on-error: ${{ github.event.inputs.force_deploy == 'true' }}

      - name: Check TypeScript
        run: npx tsc --noEmit
        continue-on-error: ${{ github.event.inputs.force_deploy == 'true' }}

      - name: Security audit
        run: npm audit --audit-level=high
        continue-on-error: true

  # æž„å»ºå’ŒæŽ¨é€ Docker é•œåƒ
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: [determine-environment, pre-deployment-checks]
    if: needs.determine-environment.outputs.should_deploy == 'true'
    permissions:
      contents: read
      packages: write
    outputs:
      image: ${{ steps.image.outputs.image }}
      digest: ${{ steps.build.outputs.digest }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value=${{ needs.determine-environment.outputs.environment }}

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NODE_ENV=production
            NEXT_TELEMETRY_DISABLED=1

      - name: Generate image reference
        id: image
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.determine-environment.outputs.environment }}"
          echo "image=$IMAGE" >> $GITHUB_OUTPUT
          echo "ðŸ³ æž„å»ºé•œåƒ: $IMAGE" >> $GITHUB_STEP_SUMMARY

  # å¼€å‘çŽ¯å¢ƒéƒ¨ç½²
  deploy-development:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: [determine-environment, build-and-push]
    if: needs.determine-environment.outputs.environment == 'development'
    environment:
      name: development
      url: https://dev.zkagent.example.com
    steps:
      - name: Deploy to development
        run: |
          echo "ðŸš€ éƒ¨ç½²åˆ°å¼€å‘çŽ¯å¢ƒ" >> $GITHUB_STEP_SUMMARY
          echo "- **é•œåƒ**: ${{ needs.build-and-push.outputs.image }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬**: ${{ needs.determine-environment.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          
          # è¿™é‡Œæ·»åŠ å®žé™…çš„éƒ¨ç½²é€»è¾‘
          # ä¾‹å¦‚ï¼škubectlã€docker-composeã€æˆ–å…¶ä»–éƒ¨ç½²å·¥å…·
          
          # æ¨¡æ‹Ÿéƒ¨ç½²è¿‡ç¨‹
          echo "æ­£åœ¨æ›´æ–°å¼€å‘çŽ¯å¢ƒ..."
          sleep 10
          echo "âœ… å¼€å‘çŽ¯å¢ƒéƒ¨ç½²å®Œæˆ"

      - name: Run smoke tests
        run: |
          echo "ðŸ§ª è¿è¡Œå†’çƒŸæµ‹è¯•"
          # æ·»åŠ åŸºæœ¬çš„å¥åº·æ£€æŸ¥
          # curl -f https://dev.zkagent.example.com/api/health
          echo "âœ… å†’çƒŸæµ‹è¯•é€šè¿‡"

      - name: Notify development team
        run: |
          echo "ðŸ“¢ é€šçŸ¥å¼€å‘å›¢é˜Ÿéƒ¨ç½²å®Œæˆ"
          # è¿™é‡Œå¯ä»¥æ·»åŠ  Slackã€Teams æˆ–é‚®ä»¶é€šçŸ¥

  # é¢„ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [determine-environment, build-and-push]
    if: needs.determine-environment.outputs.environment == 'staging'
    environment:
      name: staging
      url: https://staging.zkagent.example.com
    steps:
      - name: Deploy to staging
        run: |
          echo "ðŸš€ éƒ¨ç½²åˆ°é¢„ç”Ÿäº§çŽ¯å¢ƒ" >> $GITHUB_STEP_SUMMARY
          echo "- **é•œåƒ**: ${{ needs.build-and-push.outputs.image }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬**: ${{ needs.determine-environment.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          
          # é¢„ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²é€»è¾‘
          echo "æ­£åœ¨æ›´æ–°é¢„ç”Ÿäº§çŽ¯å¢ƒ..."
          sleep 15
          echo "âœ… é¢„ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²å®Œæˆ"

      - name: Run integration tests
        run: |
          echo "ðŸ”§ è¿è¡Œé›†æˆæµ‹è¯•"
          # è¿è¡Œæ›´å…¨é¢çš„æµ‹è¯•å¥—ä»¶
          echo "âœ… é›†æˆæµ‹è¯•é€šè¿‡"

      - name: Performance baseline check
        run: |
          echo "ðŸ“Š æ€§èƒ½åŸºçº¿æ£€æŸ¥"
          # è¿è¡Œæ€§èƒ½æµ‹è¯•ï¼Œç¡®ä¿æ²¡æœ‰å›žå½’
          echo "âœ… æ€§èƒ½æ£€æŸ¥é€šè¿‡"

  # ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [determine-environment, build-and-push]
    if: needs.determine-environment.outputs.environment == 'production'
    environment:
      name: production
      url: https://zkagent.example.com
    steps:
      - name: Create deployment backup
        run: |
          echo "ðŸ’¾ åˆ›å»ºéƒ¨ç½²å¤‡ä»½"
          # å¤‡ä»½å½“å‰ç”Ÿäº§çŽ¯å¢ƒçŠ¶æ€
          echo "âœ… å¤‡ä»½å®Œæˆ"

      - name: Deploy to production
        run: |
          echo "ðŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒ" >> $GITHUB_STEP_SUMMARY
          echo "- **é•œåƒ**: ${{ needs.build-and-push.outputs.image }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬**: ${{ needs.determine-environment.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          
          # ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²é€»è¾‘ï¼ˆè“ç»¿éƒ¨ç½²æˆ–æ»šåŠ¨æ›´æ–°ï¼‰
          echo "æ­£åœ¨æ‰§è¡Œè“ç»¿éƒ¨ç½²..."
          sleep 20
          echo "âœ… ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²å®Œæˆ"

      - name: Run production health checks
        run: |
          echo "ðŸ¥ è¿è¡Œç”Ÿäº§çŽ¯å¢ƒå¥åº·æ£€æŸ¥"
          # å…¨é¢çš„å¥åº·æ£€æŸ¥
          echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"

      - name: Update monitoring and alerts
        run: |
          echo "ðŸ“Š æ›´æ–°ç›‘æŽ§å’Œå‘Šè­¦"
          # æ›´æ–°ç›‘æŽ§ä»ªè¡¨æ¿å’Œå‘Šè­¦è§„åˆ™
          echo "âœ… ç›‘æŽ§æ›´æ–°å®Œæˆ"

      - name: Notify stakeholders
        run: |
          echo "ðŸ“¢ é€šçŸ¥ç›¸å…³äººå‘˜"
          # é€šçŸ¥äº§å“å›¢é˜Ÿã€è¿ç»´å›¢é˜Ÿç­‰
          echo "âœ… é€šçŸ¥å‘é€å®Œæˆ"

  # éƒ¨ç½²åŽéªŒè¯
  post-deployment-verification:
    name: Post-deployment Verification
    runs-on: ubuntu-latest
    needs: [determine-environment, deploy-development, deploy-staging, deploy-production]
    if: always() && needs.determine-environment.outputs.should_deploy == 'true'
    steps:
      - name: Verify deployment
        run: |
          ENVIRONMENT="${{ needs.determine-environment.outputs.environment }}"
          
          echo "## ðŸ” éƒ¨ç½²åŽéªŒè¯" >> $GITHUB_STEP_SUMMARY
          echo "- **çŽ¯å¢ƒ**: $ENVIRONMENT" >> $GITHUB_STEP_SUMMARY
          
          case $ENVIRONMENT in
            "development")
              if [ "${{ needs.deploy-development.result }}" = "success" ]; then
                echo "âœ… å¼€å‘çŽ¯å¢ƒéƒ¨ç½²æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
              else
                echo "âŒ å¼€å‘çŽ¯å¢ƒéƒ¨ç½²å¤±è´¥" >> $GITHUB_STEP_SUMMARY
              fi
              ;;
            "staging")
              if [ "${{ needs.deploy-staging.result }}" = "success" ]; then
                echo "âœ… é¢„ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
              else
                echo "âŒ é¢„ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²å¤±è´¥" >> $GITHUB_STEP_SUMMARY
              fi
              ;;
            "production")
              if [ "${{ needs.deploy-production.result }}" = "success" ]; then
                echo "âœ… ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
              else
                echo "âŒ ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²å¤±è´¥" >> $GITHUB_STEP_SUMMARY
              fi
              ;;
          esac

      - name: Generate deployment report
        run: |
          cat > deployment-report.md << EOF
          # éƒ¨ç½²æŠ¥å‘Š
          
          ## åŸºæœ¬ä¿¡æ¯
          - **éƒ¨ç½²æ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - **éƒ¨ç½²çŽ¯å¢ƒ**: ${{ needs.determine-environment.outputs.environment }}
          - **éƒ¨ç½²ç‰ˆæœ¬**: ${{ needs.determine-environment.outputs.version }}
          - **è§¦å‘æ–¹å¼**: ${{ github.event_name }}
          - **éƒ¨ç½²äººå‘˜**: ${{ github.actor }}
          
          ## éƒ¨ç½²çŠ¶æ€
          - **é¢„æ£€æŸ¥**: ${{ needs.pre-deployment-checks.result }}
          - **é•œåƒæž„å»º**: ${{ needs.build-and-push.result }}
          - **çŽ¯å¢ƒéƒ¨ç½²**: ${{ 
            needs.determine-environment.outputs.environment == 'development' && needs.deploy-development.result ||
            needs.determine-environment.outputs.environment == 'staging' && needs.deploy-staging.result ||
            needs.determine-environment.outputs.environment == 'production' && needs.deploy-production.result
          }}
          
          ## é•œåƒä¿¡æ¯
          - **é•œåƒ**: ${{ needs.build-and-push.outputs.image }}
          - **æ‘˜è¦**: ${{ needs.build-and-push.outputs.digest }}
          
          ## åŽç»­æ­¥éª¤
          - [ ] ç›‘æŽ§åº”ç”¨æ€§èƒ½æŒ‡æ ‡
          - [ ] æ£€æŸ¥é”™è¯¯æ—¥å¿—
          - [ ] éªŒè¯å…³é”®åŠŸèƒ½
          - [ ] æ›´æ–°æ–‡æ¡£
          EOF

      - name: Upload deployment report
        uses: actions/upload-artifact@v4
        with:
          name: deployment-report-${{ needs.determine-environment.outputs.environment }}
          path: deployment-report.md
          retention-days: 90

  # å›žæ»šå‡†å¤‡
  prepare-rollback:
    name: Prepare Rollback
    runs-on: ubuntu-latest
    needs: [determine-environment, post-deployment-verification]
    if: failure() && needs.determine-environment.outputs.environment == 'production'
    steps:
      - name: Prepare rollback information
        run: |
          echo "## ðŸ”„ å›žæ»šå‡†å¤‡" >> $GITHUB_STEP_SUMMARY
          echo "ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²å¤±è´¥ï¼Œå‡†å¤‡å›žæ»šä¿¡æ¯ï¼š" >> $GITHUB_STEP_SUMMARY
          echo "- **å¤±è´¥ç‰ˆæœ¬**: ${{ needs.determine-environment.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **å›žæ»šå‘½ä»¤**: è¯·æ‰‹åŠ¨æ‰§è¡Œå›žæ»šæ“ä½œ" >> $GITHUB_STEP_SUMMARY
          
          # åˆ›å»ºå›žæ»šè„šæœ¬
          cat > rollback.sh << 'EOF'
          #!/bin/bash
          echo "æ‰§è¡Œç”Ÿäº§çŽ¯å¢ƒå›žæ»š..."
          # æ·»åŠ å®žé™…çš„å›žæ»šé€»è¾‘
          # kubectl rollout undo deployment/zkagent
          # æˆ–å…¶ä»–å›žæ»šå‘½ä»¤
          echo "å›žæ»šå®Œæˆ"
          EOF
          
          chmod +x rollback.sh

      - name: Upload rollback script
        uses: actions/upload-artifact@v4
        with:
          name: rollback-script
          path: rollback.sh
          retention-days: 30

      - name: Create rollback issue
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ðŸš¨ ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²å¤±è´¥ - éœ€è¦å›žæ»š (${new Date().toISOString().split('T')[0]})`;
            const body = `## éƒ¨ç½²å¤±è´¥æŠ¥å‘Š\n\n` +
              `ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²å¤±è´¥ï¼Œéœ€è¦ç«‹å³å›žæ»šï¼š\n\n` +
              `- **å¤±è´¥ç‰ˆæœ¬**: ${{ needs.determine-environment.outputs.version }}\n` +
              `- **éƒ¨ç½²æ—¶é—´**: ${new Date().toISOString()}\n` +
              `- **å·¥ä½œæµ**: ${context.workflow}\n` +
              `- **è¿è¡ŒID**: ${context.runId}\n\n` +
              `### å›žæ»šæ­¥éª¤\n` +
              `1. ä¸‹è½½å›žæ»šè„šæœ¬\n` +
              `2. æ‰§è¡Œå›žæ»šæ“ä½œ\n` +
              `3. éªŒè¯å›žæ»šç»“æžœ\n` +
              `4. æ›´æ–°ç›‘æŽ§çŠ¶æ€\n\n` +
              `### åŽç»­è¡ŒåŠ¨\n` +
              `- [ ] åˆ†æžå¤±è´¥åŽŸå› \n` +
              `- [ ] ä¿®å¤é—®é¢˜\n` +
              `- [ ] é‡æ–°éƒ¨ç½²\n` +
              `- [ ] æ›´æ–°éƒ¨ç½²æµç¨‹`;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['deployment', 'production', 'critical', 'rollback-needed'],
              assignees: ['${{ github.actor }}']
            });