# ZK-Agent å¤šç¯å¢ƒéƒ¨ç½²æ ‡å‡†åŒ–æ–¹æ¡ˆ

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–¹æ¡ˆæ—¨åœ¨ç¡®ä¿ZK-Agenté¡¹ç›®åœ¨å¼€å‘ã€æµ‹è¯•ã€é¢„ç”Ÿäº§å’Œç”Ÿäº§ç¯å¢ƒä¸­çš„ä¸€è‡´æ€§éƒ¨ç½²ï¼Œé€šè¿‡æ ‡å‡†åŒ–é…ç½®å’Œè‡ªåŠ¨åŒ–æµç¨‹æå‡éƒ¨ç½²æ•ˆç‡å’Œå¯é æ€§ã€‚

## ğŸ¯ æ ‡å‡†åŒ–ç›®æ ‡

### 1. ç¯å¢ƒä¸€è‡´æ€§
- **é…ç½®æ ‡å‡†åŒ–**: ç»Ÿä¸€ç¯å¢ƒå˜é‡å’Œé…ç½®æ–‡ä»¶æ ¼å¼
- **å®¹å™¨åŒ–ä¸€è‡´æ€§**: ç›¸åŒçš„Dockeré•œåƒå’Œå®¹å™¨é…ç½®
- **ä¾èµ–ç‰ˆæœ¬é”å®š**: ç¡®ä¿æ‰€æœ‰ç¯å¢ƒä½¿ç”¨ç›¸åŒç‰ˆæœ¬çš„ä¾èµ–
- **æ•°æ®åº“schemaåŒæ­¥**: ç»Ÿä¸€çš„æ•°æ®åº“ç»“æ„å’Œè¿ç§»è„šæœ¬

### 2. éƒ¨ç½²æµç¨‹æ ‡å‡†åŒ–
- **CI/CDæµæ°´çº¿ç»Ÿä¸€**: æ ‡å‡†åŒ–çš„æ„å»ºã€æµ‹è¯•ã€éƒ¨ç½²æµç¨‹
- **ç¯å¢ƒåˆ‡æ¢è‡ªåŠ¨åŒ–**: ä¸€é”®åˆ‡æ¢ä¸åŒç¯å¢ƒé…ç½®
- **å›æ»šæœºåˆ¶æ ‡å‡†åŒ–**: ç»Ÿä¸€çš„ç‰ˆæœ¬å›æ»šç­–ç•¥
- **ç›‘æ§å’Œæ—¥å¿—ç»Ÿä¸€**: ç›¸åŒçš„ç›‘æ§æŒ‡æ ‡å’Œæ—¥å¿—æ ¼å¼

## ğŸ—ï¸ ç¯å¢ƒæ¶æ„è®¾è®¡

### A. ç¯å¢ƒåˆ†å±‚ç­–ç•¥

```yaml
# ç¯å¢ƒé…ç½®å±‚æ¬¡ç»“æ„
environments:
  development:
    purpose: "æœ¬åœ°å¼€å‘å’ŒåŠŸèƒ½æµ‹è¯•"
    resources: "æœ€å°åŒ–èµ„æºé…ç½®"
    data: "æ¨¡æ‹Ÿæ•°æ®å’Œæµ‹è¯•æ•°æ®"
    
  testing:
    purpose: "è‡ªåŠ¨åŒ–æµ‹è¯•å’Œé›†æˆæµ‹è¯•"
    resources: "ä¸­ç­‰èµ„æºé…ç½®"
    data: "æ ‡å‡†æµ‹è¯•æ•°æ®é›†"
    
  staging:
    purpose: "é¢„ç”Ÿäº§éªŒè¯å’Œç”¨æˆ·éªŒæ”¶æµ‹è¯•"
    resources: "æ¥è¿‘ç”Ÿäº§ç¯å¢ƒé…ç½®"
    data: "ç”Ÿäº§æ•°æ®å‰¯æœ¬ï¼ˆè„±æ•ï¼‰"
    
  production:
    purpose: "ç”Ÿäº§ç¯å¢ƒæœåŠ¡"
    resources: "é«˜å¯ç”¨å’Œé«˜æ€§èƒ½é…ç½®"
    data: "çœŸå®ç”Ÿäº§æ•°æ®"
```

### B. é…ç½®ç®¡ç†ç­–ç•¥

```typescript
// ç¯å¢ƒé…ç½®æ¥å£å®šä¹‰
interface EnvironmentConfig {
  name: string;
  database: DatabaseConfig;
  redis: RedisConfig;
  ai: AIServiceConfig;
  storage: StorageConfig;
  monitoring: MonitoringConfig;
  security: SecurityConfig;
}

// é…ç½®å·¥å‚æ¨¡å¼
class ConfigFactory {
  static createConfig(env: string): EnvironmentConfig {
    const baseConfig = this.getBaseConfig();
    const envOverrides = this.getEnvironmentOverrides(env);
    
    return {
      ...baseConfig,
      ...envOverrides,
      name: env
    };
  }
  
  private static getBaseConfig(): Partial<EnvironmentConfig> {
    return {
      database: {
        type: 'postgresql',
        ssl: true,
        poolSize: 10
      },
      redis: {
        keyPrefix: 'zk-agent:',
        ttl: 3600
      },
      ai: {
        timeout: 30000,
        retries: 3
      }
    };
  }
  
  private static getEnvironmentOverrides(env: string): Partial<EnvironmentConfig> {
    const overrides = {
      development: {
        database: { poolSize: 5, ssl: false },
        ai: { timeout: 60000 },
        monitoring: { enabled: false }
      },
      testing: {
        database: { poolSize: 3 },
        ai: { mockMode: true },
        monitoring: { enabled: true, level: 'info' }
      },
      staging: {
        database: { poolSize: 8 },
        monitoring: { enabled: true, level: 'warn' }
      },
      production: {
        database: { poolSize: 20 },
        monitoring: { enabled: true, level: 'error' },
        security: { strictMode: true }
      }
    };
    
    return overrides[env] || {};
  }
}
```

## ğŸ³ å®¹å™¨åŒ–æ ‡å‡†é…ç½®

### A. å¤šé˜¶æ®µDockerfile

```dockerfile
# å¤šç¯å¢ƒDockerfile
FROM node:18-alpine AS base
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

# å¼€å‘ç¯å¢ƒ
FROM base AS development
RUN npm ci
COPY . .
EXPOSE 3000
CMD ["npm", "run", "dev"]

# æ„å»ºé˜¶æ®µ
FROM base AS builder
RUN npm ci
COPY . .
RUN npm run build

# ç”Ÿäº§ç¯å¢ƒ
FROM base AS production
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/public ./public
EXPOSE 3000
USER node
CMD ["npm", "start"]

# æµ‹è¯•ç¯å¢ƒ
FROM builder AS testing
RUN npm run test:coverage
CMD ["npm", "run", "test:watch"]
```

### B. Docker Composeé…ç½®

```yaml
# docker-compose.base.yml - åŸºç¡€é…ç½®
version: '3.8'

services:
  frontend:
    build:
      context: .
      target: ${BUILD_TARGET:-production}
    environment:
      - NODE_ENV=${NODE_ENV}
      - API_URL=${API_URL}
    volumes:
      - ${UPLOAD_PATH}:/app/uploads
    
  backend:
    build:
      context: ./backend
      target: ${BUILD_TARGET:-production}
    environment:
      - NODE_ENV=${NODE_ENV}
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
    depends_on:
      - database
      - redis
      
  database:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=${DB_NAME}
      - POSTGRES_USER=${DB_USER}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      
  redis:
    image: redis:7-alpine
    command: redis-server --requirepass ${REDIS_PASSWORD}
    
volumes:
  postgres_data:

---
# docker-compose.dev.yml - å¼€å‘ç¯å¢ƒè¦†ç›–
version: '3.8'

services:
  frontend:
    build:
      target: development
    volumes:
      - .:/app
      - /app/node_modules
    ports:
      - "3000:3000"
      
  backend:
    build:
      target: development
    volumes:
      - ./backend:/app
      - /app/node_modules
    ports:
      - "3001:3001"
      
  database:
    ports:
      - "5432:5432"
      
  redis:
    ports:
      - "6379:6379"

---
# docker-compose.prod.yml - ç”Ÿäº§ç¯å¢ƒè¦†ç›–
version: '3.8'

services:
  frontend:
    restart: unless-stopped
    deploy:
      replicas: 2
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
          
  backend:
    restart: unless-stopped
    deploy:
      replicas: 3
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
          
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - frontend
      - backend
```

## ğŸ—„ï¸ æ•°æ®åº“è¿ç§»ç®¡ç†

### A. è¿ç§»è„šæœ¬æ ‡å‡†åŒ–

```typescript
// æ•°æ®åº“è¿ç§»ç®¡ç†å™¨
class MigrationManager {
  private migrations: Migration[] = [];
  
  async runMigrations(targetEnv: string) {
    const pendingMigrations = await this.getPendingMigrations(targetEnv);
    
    for (const migration of pendingMigrations) {
      try {
        await this.executeMigration(migration, targetEnv);
        await this.recordMigration(migration, targetEnv);
        console.log(`âœ… è¿ç§»å®Œæˆ: ${migration.name}`);
      } catch (error) {
        console.error(`âŒ è¿ç§»å¤±è´¥: ${migration.name}`, error);
        await this.rollbackMigration(migration, targetEnv);
        throw error;
      }
    }
  }
  
  async generateMigration(name: string, changes: SchemaChange[]) {
    const timestamp = new Date().toISOString().replace(/[^0-9]/g, '').slice(0, 14);
    const fileName = `${timestamp}_${name}.sql`;
    
    const upSql = this.generateUpSQL(changes);
    const downSql = this.generateDownSQL(changes);
    
    await this.writeMigrationFile(fileName, { up: upSql, down: downSql });
  }
  
  private async executeMigration(migration: Migration, env: string) {
    const config = ConfigFactory.createConfig(env);
    const db = new Database(config.database);
    
    await db.transaction(async (trx) => {
      await trx.raw(migration.upSQL);
    });
  }
}
```

### B. æ•°æ®ç§å­ç®¡ç†

```typescript
// æ•°æ®ç§å­ç®¡ç†
class SeedManager {
  private seeds: { [env: string]: Seed[] } = {
    development: [
      new UserSeed(),
      new CADFileSeed(),
      new PosterTemplateSeed()
    ],
    testing: [
      new TestUserSeed(),
      new TestDataSeed()
    ],
    staging: [
      new StagingUserSeed(),
      new ProductionDataSubsetSeed()
    ]
    // ç”Ÿäº§ç¯å¢ƒä¸ä½¿ç”¨ç§å­æ•°æ®
  };
  
  async seedDatabase(env: string) {
    const envSeeds = this.seeds[env] || [];
    
    for (const seed of envSeeds) {
      try {
        await seed.run();
        console.log(`âœ… ç§å­æ•°æ®å®Œæˆ: ${seed.name}`);
      } catch (error) {
        console.error(`âŒ ç§å­æ•°æ®å¤±è´¥: ${seed.name}`, error);
        throw error;
      }
    }
  }
}
```

## ğŸ”„ CI/CDæµæ°´çº¿æ ‡å‡†åŒ–

### A. GitHub Actionsé…ç½®

```yaml
# .github/workflows/deploy.yml
name: Multi-Environment Deployment

on:
  push:
    branches: [main, develop, staging]
  pull_request:
    branches: [main]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: zk-agent

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run tests
        run: npm run test:coverage
        
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        
  build:
    needs: test
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
        
      - name: Log in to Container Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            
      - name: Build and push
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          
  deploy-dev:
    if: github.ref == 'refs/heads/develop'
    needs: build
    runs-on: ubuntu-latest
    environment: development
    steps:
      - name: Deploy to Development
        run: |
          echo "Deploying to development environment"
          # éƒ¨ç½²è„šæœ¬
          
  deploy-staging:
    if: github.ref == 'refs/heads/staging'
    needs: build
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - name: Deploy to Staging
        run: |
          echo "Deploying to staging environment"
          # éƒ¨ç½²è„šæœ¬
          
  deploy-prod:
    if: github.ref == 'refs/heads/main'
    needs: build
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Deploy to Production
        run: |
          echo "Deploying to production environment"
          # éƒ¨ç½²è„šæœ¬
```

### B. éƒ¨ç½²è„šæœ¬æ ‡å‡†åŒ–

```bash
#!/bin/bash
# deploy.sh - ç»Ÿä¸€éƒ¨ç½²è„šæœ¬

set -e

ENVIRONMENT=${1:-development}
IMAGE_TAG=${2:-latest}

echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ° $ENVIRONMENT ç¯å¢ƒ"

# éªŒè¯ç¯å¢ƒå‚æ•°
case $ENVIRONMENT in
    development|testing|staging|production)
        echo "âœ… ç¯å¢ƒéªŒè¯é€šè¿‡: $ENVIRONMENT"
        ;;
    *)
        echo "âŒ æ— æ•ˆç¯å¢ƒ: $ENVIRONMENT"
        exit 1
        ;;
esac

# åŠ è½½ç¯å¢ƒé…ç½®
source "./config/env.$ENVIRONMENT.sh"

# é¢„éƒ¨ç½²æ£€æŸ¥
echo "ğŸ” æ‰§è¡Œé¢„éƒ¨ç½²æ£€æŸ¥..."
./scripts/pre-deploy-check.sh $ENVIRONMENT

# æ•°æ®åº“è¿ç§»
echo "ğŸ—„ï¸ æ‰§è¡Œæ•°æ®åº“è¿ç§»..."
docker-compose -f docker-compose.yml -f docker-compose.$ENVIRONMENT.yml run --rm backend npm run migrate

# éƒ¨ç½²åº”ç”¨
echo "ğŸ“¦ éƒ¨ç½²åº”ç”¨..."
docker-compose -f docker-compose.yml -f docker-compose.$ENVIRONMENT.yml up -d

# å¥åº·æ£€æŸ¥
echo "ğŸ¥ æ‰§è¡Œå¥åº·æ£€æŸ¥..."
./scripts/health-check.sh $ENVIRONMENT

# éƒ¨ç½²åéªŒè¯
echo "âœ… æ‰§è¡Œéƒ¨ç½²åéªŒè¯..."
./scripts/post-deploy-verify.sh $ENVIRONMENT

echo "ğŸ‰ éƒ¨ç½²å®Œæˆ!"
```

## ğŸ“Š ç¯å¢ƒç›‘æ§ç»Ÿä¸€åŒ–

### A. ç›‘æ§é…ç½®æ ‡å‡†åŒ–

```yaml
# monitoring/prometheus.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

rule_files:
  - "alert_rules.yml"

scrape_configs:
  - job_name: 'zk-agent-frontend'
    static_configs:
      - targets: ['frontend:3000']
    metrics_path: '/metrics'
    
  - job_name: 'zk-agent-backend'
    static_configs:
      - targets: ['backend:3001']
    metrics_path: '/api/metrics'
    
  - job_name: 'postgres'
    static_configs:
      - targets: ['postgres-exporter:9187']
      
  - job_name: 'redis'
    static_configs:
      - targets: ['redis-exporter:9121']

alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - alertmanager:9093
```

### B. æ—¥å¿—æ ‡å‡†åŒ–

```typescript
// ç»Ÿä¸€æ—¥å¿—æ ¼å¼
class StandardLogger {
  private winston: Winston.Logger;
  
  constructor(environment: string) {
    this.winston = winston.createLogger({
      level: this.getLogLevel(environment),
      format: winston.format.combine(
        winston.format.timestamp(),
        winston.format.errors({ stack: true }),
        winston.format.json(),
        winston.format.printf(({ timestamp, level, message, ...meta }) => {
          return JSON.stringify({
            timestamp,
            level,
            message,
            environment,
            service: 'zk-agent',
            ...meta
          });
        })
      ),
      transports: this.getTransports(environment)
    });
  }
  
  private getLogLevel(env: string): string {
    const levels = {
      development: 'debug',
      testing: 'info',
      staging: 'warn',
      production: 'error'
    };
    return levels[env] || 'info';
  }
  
  private getTransports(env: string): winston.transport[] {
    const transports = [new winston.transports.Console()];
    
    if (env !== 'development') {
      transports.push(
        new winston.transports.File({
          filename: '/var/log/zk-agent/error.log',
          level: 'error'
        }),
        new winston.transports.File({
          filename: '/var/log/zk-agent/combined.log'
        })
      );
    }
    
    return transports;
  }
}
```

## ğŸš€ å®æ–½è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼šé…ç½®æ ‡å‡†åŒ–ï¼ˆ1å‘¨ï¼‰
1. ç¯å¢ƒé…ç½®æ–‡ä»¶æ ‡å‡†åŒ–
2. Dockeré…ç½®ç»Ÿä¸€
3. ç¯å¢ƒå˜é‡ç®¡ç†

### ç¬¬äºŒé˜¶æ®µï¼šCI/CDæµæ°´çº¿ï¼ˆ2å‘¨ï¼‰
1. GitHub Actionsé…ç½®
2. è‡ªåŠ¨åŒ–æµ‹è¯•é›†æˆ
3. éƒ¨ç½²è„šæœ¬æ ‡å‡†åŒ–

### ç¬¬ä¸‰é˜¶æ®µï¼šæ•°æ®åº“ç®¡ç†ï¼ˆ1å‘¨ï¼‰
1. è¿ç§»è„šæœ¬æ ‡å‡†åŒ–
2. ç§å­æ•°æ®ç®¡ç†
3. å¤‡ä»½æ¢å¤æµç¨‹

### ç¬¬å››é˜¶æ®µï¼šç›‘æ§ç»Ÿä¸€ï¼ˆ1å‘¨ï¼‰
1. ç›‘æ§é…ç½®éƒ¨ç½²
2. æ—¥å¿—æ ¼å¼ç»Ÿä¸€
3. å‘Šè­¦è§„åˆ™é…ç½®

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

å®Œæˆæ ‡å‡†åŒ–åé¢„æœŸå®ç°ï¼š
- ğŸ¯ ç¯å¢ƒä¸€è‡´æ€§è¾¾åˆ°99%
- ğŸš€ éƒ¨ç½²æ—¶é—´ç¼©çŸ­60%
- ğŸ”„ éƒ¨ç½²æˆåŠŸç‡æå‡è‡³99.5%
- ğŸ› ç¯å¢ƒç›¸å…³é—®é¢˜å‡å°‘80%
- âš¡ é—®é¢˜å®šä½æ—¶é—´ç¼©çŸ­50%