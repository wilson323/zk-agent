# 系统层级关系说明

---

## 1. 系统分层架构

### 1.1 表现层（Presentation Layer）
- **职责**：用户界面渲染、交互处理、数据展示
- **技术栈**：Next.js + React + Tailwind CSS
- **包含模块**：所有前端页面（智能体广场、CAD分析、AI海报设计等）
- **规范**：
  - 禁止直接调用数据库或后端服务
  - 所有数据通过API层获取
  - 必须实现响应式设计

### 1.2 API网关层（API Gateway Layer）
- **职责**：路由分发、请求鉴权、限流控制
- **技术栈**：Next.js API Routes + JWT
- **关键功能**：
  - 统一认证（/api/auth）
  - 智能体路由（/api/agents）
  - 文件上传路由（/api/upload）
- **规范**：
  - 所有API必须包含版本号（v1/v2）
  - 错误码遵循HTTP标准

### 1.3 业务服务层（Business Service Layer）
- **职责**：核心业务逻辑处理
- **技术栈**：Prisma + Redis
- **子层划分**：
  - 智能体服务（Agent Service）
  - CAD分析服务（CAD Service）
  - 海报生成服务（Poster Service）
- **规范**：
  - 服务间调用必须通过接口
  - 禁止跨服务数据库访问

### 1.4 数据层（Data Layer）
- **职责**：数据持久化与缓存
- **技术栈**：PostgreSQL + Redis + S3
- **组成**：
  - 主数据库（业务数据）
  - 缓存数据库（高频访问数据）
  - 文件存储（CAD文件/海报模板）
- **规范**：
  - 所有写操作必须事务化
  - 缓存失效时间≤5分钟

### 1.5 AI集成层（AI Integration Layer）
- **职责**：第三方AI服务对接
- **集成服务**：
  - FastGPT（对话）
  - 阿里云千问（分析）
  - 硅基流动（设计）
- **规范**：
  - 必须实现熔断机制
  - API调用需日志全记录

---

## 2. 跨层交互规范

### 2.1 数据流向
```
表现层 → API网关 → 业务服务 → 数据层/AI集成层
（所有响应按原路返回）
```

### 2.2 异常处理
- 表现层：展示友好错误提示
- API网关：记录错误日志并返回标准化错误码
- 业务服务：实现重试机制

### 2.3 安全要求
- 纵向：每层需实现独立权限校验
- 横向：服务间调用需双向认证

---

## 3. 典型流程示例

### 3.1 CAD文件分析流程
```
前端上传 → API网关鉴权 → CAD服务处理 → 存储到S3 → 结果写入DB → 返回前端
```

### 3.2 智能体交互流程
```
前端请求 → API网关路由 → 智能体服务 → 调用FastGPT → 缓存结果 → 返回前端
``` 