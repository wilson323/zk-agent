# ZK-Agent ç¾å¤‡ä½“ç³»å»ºè®¾æ–¹æ¡ˆ

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–¹æ¡ˆæ—¨åœ¨ä¸ºZK-Agentå¹³å°å»ºç«‹å®Œæ•´çš„ç¾éš¾æ¢å¤å’Œå¤‡ä»½ä½“ç³»ï¼Œç¡®ä¿ç³»ç»Ÿåœ¨å„ç§æ•…éšœåœºæ™¯ä¸‹çš„å¿«é€Ÿæ¢å¤èƒ½åŠ›ã€‚

## ğŸ¯ å»ºè®¾ç›®æ ‡

### 1. å…³é”®æŒ‡æ ‡
- **RTO (æ¢å¤æ—¶é—´ç›®æ ‡)**: â‰¤ 30åˆ†é’Ÿ
- **RPO (æ¢å¤ç‚¹ç›®æ ‡)**: â‰¤ 5åˆ†é’Ÿ
- **æ•°æ®å®Œæ•´æ€§**: 99.99%
- **ç³»ç»Ÿå¯ç”¨æ€§**: 99.9%

### 2. è¦†ç›–èŒƒå›´
- æ•°æ®åº“å¤‡ä»½ä¸æ¢å¤
- æ–‡ä»¶å­˜å‚¨å¤‡ä»½
- é…ç½®æ–‡ä»¶ç®¡ç†
- ä»£ç ç‰ˆæœ¬æ§åˆ¶
- å®¹å™¨é•œåƒå¤‡ä»½
- ç³»ç»ŸçŠ¶æ€å¿«ç…§

## ğŸ—„ï¸ æ•°æ®åº“å¤‡ä»½ç­–ç•¥

### A. å¤‡ä»½ç±»å‹

```yaml
# æ•°æ®åº“å¤‡ä»½é…ç½®
backup_strategy:
  full_backup:
    frequency: daily
    time: "02:00"
    retention: 30_days
    
  incremental_backup:
    frequency: hourly
    retention: 7_days
    
  transaction_log_backup:
    frequency: every_5_minutes
    retention: 24_hours
```

### B. å¤‡ä»½è„šæœ¬

```bash
#!/bin/bash
# æ•°æ®åº“å¤‡ä»½è„šæœ¬

DB_NAME="zk_agent"
BACKUP_DIR="/backup/database"
DATE=$(date +%Y%m%d_%H%M%S)

# å…¨é‡å¤‡ä»½
full_backup() {
    echo "å¼€å§‹å…¨é‡å¤‡ä»½: $DATE"
    pg_dump -h localhost -U postgres $DB_NAME > "$BACKUP_DIR/full_${DATE}.sql"
    
    # å‹ç¼©å¤‡ä»½æ–‡ä»¶
    gzip "$BACKUP_DIR/full_${DATE}.sql"
    
    # éªŒè¯å¤‡ä»½å®Œæ•´æ€§
    if [ $? -eq 0 ]; then
        echo "å…¨é‡å¤‡ä»½å®Œæˆ: full_${DATE}.sql.gz"
        # ä¸Šä¼ åˆ°äº‘å­˜å‚¨
        aws s3 cp "$BACKUP_DIR/full_${DATE}.sql.gz" s3://zk-agent-backup/database/
    else
        echo "å¤‡ä»½å¤±è´¥!" >&2
        exit 1
    fi
}

# å¢é‡å¤‡ä»½
incremental_backup() {
    echo "å¼€å§‹å¢é‡å¤‡ä»½: $DATE"
    # ä½¿ç”¨WALæ—¥å¿—è¿›è¡Œå¢é‡å¤‡ä»½
    pg_basebackup -h localhost -U postgres -D "$BACKUP_DIR/incremental_${DATE}" -Ft -z -P
}
```

## ğŸ“ æ–‡ä»¶å­˜å‚¨å¤‡ä»½

### A. å¤‡ä»½ç­–ç•¥

```typescript
// æ–‡ä»¶å¤‡ä»½é…ç½®
interface FileBackupConfig {
  paths: {
    userUploads: '/app/uploads',
    cadFiles: '/app/cad-files',
    posterAssets: '/app/poster-assets',
    logs: '/app/logs'
  },
  schedule: {
    realtime: ['userUploads', 'cadFiles'],
    hourly: ['posterAssets'],
    daily: ['logs']
  },
  retention: {
    realtime: '7d',
    hourly: '30d',
    daily: '90d'
  }
}
```

### B. å®æ—¶åŒæ­¥æœºåˆ¶

```typescript
class FileBackupService {
  private watcher: FSWatcher;
  
  async startRealtimeBackup() {
    this.watcher = chokidar.watch(['/app/uploads', '/app/cad-files'], {
      ignored: /^\./, // å¿½ç•¥éšè—æ–‡ä»¶
      persistent: true
    });
    
    this.watcher
      .on('add', (path) => this.backupFile(path, 'add'))
      .on('change', (path) => this.backupFile(path, 'change'))
      .on('unlink', (path) => this.markFileDeleted(path));
  }
  
  private async backupFile(filePath: string, operation: string) {
    try {
      const backupPath = this.generateBackupPath(filePath);
      await fs.copyFile(filePath, backupPath);
      
      // ä¸Šä¼ åˆ°äº‘å­˜å‚¨
      await this.uploadToCloud(backupPath);
      
      // è®°å½•å¤‡ä»½æ—¥å¿—
      await this.logBackupOperation(filePath, operation, 'success');
    } catch (error) {
      await this.logBackupOperation(filePath, operation, 'failed', error);
    }
  }
}
```

## âš™ï¸ é…ç½®æ–‡ä»¶ç®¡ç†

### A. é…ç½®ç‰ˆæœ¬æ§åˆ¶

```yaml
# é…ç½®æ–‡ä»¶å¤‡ä»½ç­–ç•¥
config_backup:
  files:
    - /app/config/database.yml
    - /app/config/redis.yml
    - /app/config/app.yml
    - /app/nginx/nginx.conf
    - /app/docker-compose.yml
    
  versioning:
    enabled: true
    max_versions: 50
    
  validation:
    syntax_check: true
    test_deployment: true
```

### B. é…ç½®çƒ­å¤‡ä»½

```typescript
class ConfigBackupManager {
  async backupConfig(configPath: string) {
    const content = await fs.readFile(configPath, 'utf8');
    const hash = crypto.createHash('sha256').update(content).digest('hex');
    
    // æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
    const lastHash = await this.getLastConfigHash(configPath);
    if (hash === lastHash) {
      return; // æ— å˜æ›´ï¼Œè·³è¿‡å¤‡ä»½
    }
    
    // åˆ›å»ºç‰ˆæœ¬åŒ–å¤‡ä»½
    const timestamp = new Date().toISOString();
    const backupPath = `${configPath}.backup.${timestamp}`;
    
    await fs.writeFile(backupPath, content);
    await this.updateConfigHash(configPath, hash);
    
    // éªŒè¯é…ç½®æ–‡ä»¶è¯­æ³•
    await this.validateConfig(configPath);
  }
  
  async validateConfig(configPath: string): Promise<boolean> {
    try {
      if (configPath.endsWith('.yml') || configPath.endsWith('.yaml')) {
        yaml.load(await fs.readFile(configPath, 'utf8'));
      } else if (configPath.endsWith('.json')) {
        JSON.parse(await fs.readFile(configPath, 'utf8'));
      }
      return true;
    } catch (error) {
      throw new Error(`é…ç½®æ–‡ä»¶è¯­æ³•é”™è¯¯: ${error.message}`);
    }
  }
}
```

## ğŸ³ å®¹å™¨é•œåƒå¤‡ä»½

### A. é•œåƒå¤‡ä»½ç­–ç•¥

```bash
#!/bin/bash
# å®¹å™¨é•œåƒå¤‡ä»½è„šæœ¬

IMAGES=(
    "zk-agent/frontend:latest"
    "zk-agent/backend:latest"
    "zk-agent/cad-analyzer:latest"
    "zk-agent/poster-generator:latest"
)

REGISTRY="your-registry.com"
BACKUP_REGISTRY="backup-registry.com"

for image in "${IMAGES[@]}"; do
    echo "å¤‡ä»½é•œåƒ: $image"
    
    # æ‹‰å–æœ€æ–°é•œåƒ
    docker pull "$REGISTRY/$image"
    
    # æ ‡è®°å¤‡ä»½ç‰ˆæœ¬
    backup_tag="$BACKUP_REGISTRY/$image-$(date +%Y%m%d)"
    docker tag "$REGISTRY/$image" "$backup_tag"
    
    # æ¨é€åˆ°å¤‡ä»½ä»“åº“
    docker push "$backup_tag"
    
    # å¯¼å‡ºä¸ºtaræ–‡ä»¶
    docker save "$REGISTRY/$image" | gzip > "/backup/images/${image//\//_}-$(date +%Y%m%d).tar.gz"
done
```

## ğŸ“Š ç³»ç»ŸçŠ¶æ€å¿«ç…§

### A. å¿«ç…§å†…å®¹

```typescript
interface SystemSnapshot {
  timestamp: string;
  services: ServiceStatus[];
  resources: ResourceUsage;
  configurations: ConfigSnapshot[];
  activeConnections: number;
  queueStatus: QueueSnapshot[];
}

class SnapshotService {
  async createSnapshot(): Promise<SystemSnapshot> {
    return {
      timestamp: new Date().toISOString(),
      services: await this.getServiceStatus(),
      resources: await this.getResourceUsage(),
      configurations: await this.getConfigSnapshots(),
      activeConnections: await this.getActiveConnections(),
      queueStatus: await this.getQueueStatus()
    };
  }
  
  private async getServiceStatus(): Promise<ServiceStatus[]> {
    const services = ['frontend', 'backend', 'database', 'redis', 'nginx'];
    const statuses = await Promise.all(
      services.map(async (service) => ({
        name: service,
        status: await this.checkServiceHealth(service),
        uptime: await this.getServiceUptime(service),
        version: await this.getServiceVersion(service)
      }))
    );
    return statuses;
  }
}
```

## ğŸ”„ æ¢å¤æµç¨‹

### A. è‡ªåŠ¨æ¢å¤è„šæœ¬

```bash
#!/bin/bash
# ç¾éš¾æ¢å¤è„šæœ¬

RECOVERY_TYPE=$1  # full | partial | config
BACKUP_DATE=$2

case $RECOVERY_TYPE in
    "full")
        echo "å¼€å§‹å…¨é‡æ¢å¤..."
        ./scripts/restore-database.sh $BACKUP_DATE
        ./scripts/restore-files.sh $BACKUP_DATE
        ./scripts/restore-configs.sh $BACKUP_DATE
        ./scripts/restart-services.sh
        ;;
    "partial")
        echo "å¼€å§‹éƒ¨åˆ†æ¢å¤..."
        ./scripts/restore-database.sh $BACKUP_DATE
        ./scripts/restart-services.sh
        ;;
    "config")
        echo "å¼€å§‹é…ç½®æ¢å¤..."
        ./scripts/restore-configs.sh $BACKUP_DATE
        ./scripts/reload-configs.sh
        ;;
    *)
        echo "ç”¨æ³•: $0 {full|partial|config} [backup_date]"
        exit 1
        ;;
esac
```

## ğŸ“ˆ ç›‘æ§å’ŒéªŒè¯

### A. å¤‡ä»½éªŒè¯

```typescript
class BackupValidator {
  async validateDatabaseBackup(backupFile: string): Promise<boolean> {
    try {
      // åˆ›å»ºä¸´æ—¶æµ‹è¯•æ•°æ®åº“
      const testDb = `test_restore_${Date.now()}`;
      await this.createTestDatabase(testDb);
      
      // æ¢å¤å¤‡ä»½åˆ°æµ‹è¯•æ•°æ®åº“
      await this.restoreBackup(backupFile, testDb);
      
      // éªŒè¯æ•°æ®å®Œæ•´æ€§
      const isValid = await this.verifyDataIntegrity(testDb);
      
      // æ¸…ç†æµ‹è¯•æ•°æ®åº“
      await this.dropTestDatabase(testDb);
      
      return isValid;
    } catch (error) {
      console.error('å¤‡ä»½éªŒè¯å¤±è´¥:', error);
      return false;
    }
  }
  
  async scheduleBackupValidation() {
    // æ¯æ—¥éªŒè¯æœ€æ–°å¤‡ä»½
    cron.schedule('0 4 * * *', async () => {
      const latestBackup = await this.getLatestBackup();
      const isValid = await this.validateDatabaseBackup(latestBackup);
      
      if (!isValid) {
        await this.alertBackupFailure(latestBackup);
      }
    });
  }
}
```

## ğŸš€ å®æ–½è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€å¤‡ä»½ï¼ˆ1å‘¨ï¼‰
1. æ•°æ®åº“å¤‡ä»½è„šæœ¬éƒ¨ç½²
2. æ–‡ä»¶å­˜å‚¨å¤‡ä»½é…ç½®
3. åŸºç¡€ç›‘æ§å‘Šè­¦

### ç¬¬äºŒé˜¶æ®µï¼šé«˜çº§åŠŸèƒ½ï¼ˆ2å‘¨ï¼‰
1. å®æ—¶æ–‡ä»¶åŒæ­¥
2. é…ç½®ç‰ˆæœ¬æ§åˆ¶
3. å®¹å™¨é•œåƒå¤‡ä»½

### ç¬¬ä¸‰é˜¶æ®µï¼šè‡ªåŠ¨åŒ–æ¢å¤ï¼ˆ1å‘¨ï¼‰
1. æ¢å¤è„šæœ¬å¼€å‘
2. éªŒè¯æœºåˆ¶å®Œå–„
3. æ¼”ç»ƒæµç¨‹å»ºç«‹

### ç¬¬å››é˜¶æ®µï¼šç›‘æ§å®Œå–„ï¼ˆ1å‘¨ï¼‰
1. å¤‡ä»½çŠ¶æ€ç›‘æ§
2. æ¢å¤æ—¶é—´ç›‘æ§
3. å®¹é‡ä½¿ç”¨ç›‘æ§

## ğŸ“Š é¢„æœŸæ•ˆæœ

å®Œæˆå»ºè®¾åé¢„æœŸå®ç°ï¼š
- ğŸ¯ RTO â‰¤ 30åˆ†é’Ÿ
- ğŸ“ˆ RPO â‰¤ 5åˆ†é’Ÿ
- ğŸ”’ æ•°æ®å®Œæ•´æ€§ 99.99%
- âš¡ è‡ªåŠ¨å¤‡ä»½æˆåŠŸç‡ 99.9%