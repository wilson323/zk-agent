{"version":3,"sources":["E:\\zk-agent\\__tests__\\config\\jest-config-validator.js"],"sourcesContent":["/**\n * @file jest-config-validator.js\n * @description Jest configuration validation and error handling utilities\n * @author Jest Fix Team\n */\n\nconst fs = require('fs');\nconst path = require('path');\n\n/**\n * Validate Jest configuration\n * @param {Object} config - Jest configuration object\n * @returns {Object} Validation result\n */\nfunction validateJestConfig(config) {\n  const errors = [];\n  const warnings = [];\n  \n  // Check required fields\n  if (!config.testEnvironment) {\n    errors.push('testEnvironment is required');\n  }\n  \n  if (!config.setupFilesAfterEnv || config.setupFilesAfterEnv.length === 0) {\n    warnings.push('setupFilesAfterEnv is recommended for proper test setup');\n  }\n  \n  // Validate setup files exist\n  if (config.setupFilesAfterEnv) {\n    config.setupFilesAfterEnv.forEach(setupFile => {\n      const filePath = setupFile.replace('<rootDir>', process.cwd());\n      if (!fs.existsSync(filePath)) {\n        errors.push(`Setup file not found: ${setupFile}`);\n      }\n    });\n  }\n  \n  // Check for conflicting configurations\n  if (config.preset && config.transform) {\n    warnings.push('Both preset and transform are defined - this may cause conflicts');\n  }\n  \n  if (config.preset === 'ts-jest' && config.extensionsToTreatAsEsm) {\n    warnings.push('ts-jest preset with ESM extensions may cause issues');\n  }\n  \n  // Validate module name mappings\n  if (config.moduleNameMapper) {\n    Object.entries(config.moduleNameMapper).forEach(([pattern, replacement]) => {\n      try {\n        new RegExp(pattern);\n      } catch (error) {\n        errors.push(`Invalid regex pattern in moduleNameMapper: ${pattern}`);\n      }\n      \n      if (replacement.includes('<rootDir>')) {\n        const filePath = replacement.replace('<rootDir>', process.cwd());\n        if (!fs.existsSync(filePath) && !replacement.includes('identity-obj-proxy')) {\n          warnings.push(`Mapped file may not exist: ${replacement}`);\n        }\n      }\n    });\n  }\n  \n  // Check test timeout\n  if (config.testTimeout && config.testTimeout < 5000) {\n    warnings.push('testTimeout is very low - tests may fail due to timeout');\n  }\n  \n  if (config.testTimeout && config.testTimeout > 60000) {\n    warnings.push('testTimeout is very high - this may slow down test execution');\n  }\n  \n  // Validate coverage configuration\n  if (config.collectCoverage && !config.collectCoverageFrom) {\n    warnings.push('collectCoverage is enabled but collectCoverageFrom is not specified');\n  }\n  \n  return {\n    isValid: errors.length === 0,\n    errors,\n    warnings,\n  };\n}\n\n/**\n * Validate test environment setup\n * @returns {Object} Validation result\n */\nfunction validateTestEnvironment() {\n  const errors = [];\n  const warnings = [];\n  \n  // Check Node.js version\n  const nodeVersion = process.version;\n  const majorVersion = parseInt(nodeVersion.slice(1).split('.')[0]);\n  \n  if (majorVersion < 16) {\n    errors.push(`Node.js version ${nodeVersion} is not supported. Please use Node.js 16 or higher.`);\n  }\n  \n  // Check required globals\n  const requiredGlobals = ['TextEncoder', 'TextDecoder'];\n  requiredGlobals.forEach(globalName => {\n    if (typeof global[globalName] === 'undefined') {\n      warnings.push(`Global ${globalName} is not defined`);\n    }\n  });\n  \n  // Check Jest environment\n  if (process.env.NODE_ENV !== 'test') {\n    warnings.push('NODE_ENV is not set to \"test\"');\n  }\n  \n  // Check memory usage\n  const memoryUsage = process.memoryUsage();\n  const heapUsedMB = memoryUsage.heapUsed / 1024 / 1024;\n  \n  if (heapUsedMB > 500) {\n    warnings.push(`High memory usage detected: ${heapUsedMB.toFixed(2)}MB`);\n  }\n  \n  return {\n    isValid: errors.length === 0,\n    errors,\n    warnings,\n    info: {\n      nodeVersion,\n      memoryUsage: `${heapUsedMB.toFixed(2)}MB`,\n      platform: process.platform,\n      arch: process.arch,\n    },\n  };\n}\n\n/**\n * Safe require with error handling\n * @param {string} modulePath - Module path to require\n * @param {*} fallback - Fallback value if require fails\n * @returns {*} Required module or fallback\n */\nfunction safeRequire(modulePath, fallback = null) {\n  try {\n    return require(modulePath);\n  } catch (error) {\n    console.warn(`Failed to require ${modulePath}:`, error.message);\n    return fallback;\n  }\n}\n\n/**\n * Create safe global polyfills\n */\nfunction createSafePolyfills() {\n  const polyfills = {};\n  \n  // TextEncoder/TextDecoder polyfills\n  try {\n    const { TextEncoder, TextDecoder } = require('util');\n    polyfills.TextEncoder = TextEncoder;\n    polyfills.TextDecoder = TextDecoder;\n  } catch (error) {\n    console.warn('Failed to load TextEncoder/TextDecoder from util:', error.message);\n    \n    // Fallback implementations\n    polyfills.TextEncoder = class TextEncoder {\n      encode(str) {\n        try {\n          return Buffer.from(str, 'utf8');\n        } catch (error) {\n          console.error('TextEncoder fallback failed:', error);\n          return new Uint8Array(0);\n        }\n      }\n    };\n    \n    polyfills.TextDecoder = class TextDecoder {\n      decode(buffer) {\n        try {\n          return Buffer.from(buffer).toString('utf8');\n        } catch (error) {\n          console.error('TextDecoder fallback failed:', error);\n          return '';\n        }\n      }\n    };\n  }\n  \n  // Fetch polyfill\n  if (typeof global.fetch === 'undefined') {\n    polyfills.fetch = jest.fn(() => \n      Promise.resolve({\n        ok: true,\n        status: 200,\n        json: () => Promise.resolve({}),\n        text: () => Promise.resolve(''),\n      })\n    );\n  }\n  \n  return polyfills;\n}\n\n/**\n * Apply polyfills safely to global scope\n * @param {Object} polyfills - Polyfills to apply\n */\nfunction applySafePolyfills(polyfills) {\n  Object.entries(polyfills).forEach(([name, implementation]) => {\n    try {\n      global[name] = implementation;\n      console.log(`✓ Applied polyfill for ${name}`);\n    } catch (error) {\n      console.error(`✗ Failed to apply polyfill for ${name}:`, error.message);\n    }\n  });\n}\n\nmodule.exports = {\n  validateJestConfig,\n  validateTestEnvironment,\n  safeRequire,\n  createSafePolyfills,\n  applySafePolyfills,\n};"],"names":["fs","require","path","validateJestConfig","config","errors","warnings","testEnvironment","push","setupFilesAfterEnv","length","forEach","setupFile","filePath","replace","process","cwd","existsSync","preset","transform","extensionsToTreatAsEsm","moduleNameMapper","Object","entries","pattern","replacement","RegExp","error","includes","testTimeout","collectCoverage","collectCoverageFrom","isValid","validateTestEnvironment","nodeVersion","version","majorVersion","parseInt","slice","split","requiredGlobals","globalName","global","env","NODE_ENV","memoryUsage","heapUsedMB","heapUsed","toFixed","info","platform","arch","safeRequire","modulePath","fallback","console","warn","message","createSafePolyfills","polyfills","TextEncoder","TextDecoder","encode","str","Buffer","from","Uint8Array","decode","buffer","toString","fetch","jest","fn","Promise","resolve","ok","status","json","text","applySafePolyfills","name","implementation","log","module","exports"],"mappings":"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"}