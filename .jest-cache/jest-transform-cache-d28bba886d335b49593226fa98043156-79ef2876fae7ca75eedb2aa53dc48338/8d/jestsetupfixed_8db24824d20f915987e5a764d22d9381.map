{"version":3,"sources":["E:\\zk-agent\\jest.setup.fixed.js"],"sourcesContent":["/**\n * @file jest.setup.fixed.js\n * @description 修复后的Jest设置 - 解决死循环问题\n * @author 修复团队\n * @lastUpdate 2024-12-19\n */\n\nrequire('@testing-library/jest-dom');\n// require('jest-extended'); // 移除未安装的依赖\nconst { TextEncoder, TextDecoder } = require('util');\nconst { server } = require('./__tests__/mocks/server');\n\n// 全局变量设置\nglobal.TextEncoder = TextEncoder;\nglobal.TextDecoder = TextDecoder;\n\n// 环境变量Mock\nprocess.env.NODE_ENV = 'test';\nprocess.env.DATABASE_URL = 'postgresql://test:test@localhost:5432/test_db';\nprocess.env.JWT_SECRET = 'test-jwt-secret-key-for-testing-purposes-only-32-chars-minimum';\nprocess.env.NEXTAUTH_SECRET = 'test-nextauth-secret-key-for-testing-purposes-only-32-chars-minimum';\nprocess.env.NEXTAUTH_URL = 'http://localhost:3000';\nprocess.env.REDIS_URL = 'redis://localhost:6379';\n\n// AI服务Mock配置\nprocess.env.FASTGPT_API_URL = 'https://api.fastgpt.test';\nprocess.env.FASTGPT_API_KEY = 'test-fastgpt-key';\nprocess.env.QWEN_BASE_URL = 'https://dashscope.test.com';\nprocess.env.QWEN_API_KEY = 'test-qwen-key';\nprocess.env.SILICONFLOW_BASE_URL = 'https://api.siliconflow.test';\nprocess.env.SILICONFLOW_API_KEY = 'test-siliconflow-key';\n\n// 启用Mock数据\nprocess.env.ENABLE_MOCKS = 'true';\n\n// 全局Mock设置\nglobal.fetch = jest.fn();\nglobal.console = {\n  ...console,\n  // 在测试中静默某些日志\n  log: jest.fn(),\n  debug: jest.fn(),\n  info: jest.fn(),\n  warn: console.warn,\n  error: console.error,\n};\n\n// Next.js Router Mock\njest.mock('next/navigation', () => ({\n  useRouter: () => ({\n    push: jest.fn(),\n    replace: jest.fn(),\n    back: jest.fn(),\n    forward: jest.fn(),\n    refresh: jest.fn(),\n    prefetch: jest.fn(),\n  }),\n  useSearchParams: () => ({\n    get: jest.fn(),\n    getAll: jest.fn(),\n    has: jest.fn(),\n    keys: jest.fn(),\n    values: jest.fn(),\n    entries: jest.fn(),\n    forEach: jest.fn(),\n    toString: jest.fn(),\n  }),\n  usePathname: () => '/test-path',\n}));\n\n// Prisma Mock\njest.mock('@prisma/client', () => ({\n  PrismaClient: jest.fn().mockImplementation(() => ({\n    $connect: jest.fn(),\n    $disconnect: jest.fn(),\n    $transaction: jest.fn(),\n    $queryRaw: jest.fn(),\n    $executeRaw: jest.fn(),\n    user: {\n      findMany: jest.fn(),\n      findUnique: jest.fn(),\n      findFirst: jest.fn(),\n      create: jest.fn(),\n      update: jest.fn(),\n      delete: jest.fn(),\n      count: jest.fn(),\n    },\n    agentConfig: {\n      findMany: jest.fn(),\n      findUnique: jest.fn(),\n      create: jest.fn(),\n      update: jest.fn(),\n      delete: jest.fn(),\n    },\n    chatSession: {\n      findMany: jest.fn(),\n      findUnique: jest.fn(),\n      create: jest.fn(),\n      update: jest.fn(),\n      delete: jest.fn(),\n    },\n    chatMessage: {\n      findMany: jest.fn(),\n      create: jest.fn(),\n      update: jest.fn(),\n      delete: jest.fn(),\n    },\n    posterTask: {\n      findMany: jest.fn(),\n      findUnique: jest.fn(),\n      create: jest.fn(),\n      update: jest.fn(),\n      delete: jest.fn(),\n    },\n    errorLog: {\n      create: jest.fn(),\n      findMany: jest.fn(),\n    },\n    usageStats: {\n      create: jest.fn(),\n      findMany: jest.fn(),\n    },\n  })),\n  Prisma: {\n    TransactionIsolationLevel: {\n      ReadCommitted: 'ReadCommitted',\n      ReadUncommitted: 'ReadUncommitted',\n      RepeatableRead: 'RepeatableRead',\n      Serializable: 'Serializable',\n    },\n  },\n}));\n\n// File System Mock\njest.mock('fs/promises', () => ({\n  readFile: jest.fn(),\n  writeFile: jest.fn(),\n  unlink: jest.fn(),\n  mkdir: jest.fn(),\n  readdir: jest.fn(),\n  stat: jest.fn(),\n  access: jest.fn(),\n}));\n\n// Crypto Mock\nObject.defineProperty(global, 'crypto', {\n  value: {\n    randomUUID: () => 'test-uuid-' + Math.random().toString(36).substr(2, 9),\n    getRandomValues: (arr) => {\n      for (let i = 0; i < arr.length; i++) {\n        arr[i] = Math.floor(Math.random() * 256);\n      }\n      return arr;\n    },\n  },\n});\n\n// MSW Server Setup - 严格模式，避免死循环\nbeforeAll(() => {\n  server.listen({\n    onUnhandledRequest: 'error', // 严格模式：未处理的请求会导致测试失败\n  });\n});\n\nafterEach(() => {\n  server.resetHandlers();\n  jest.clearAllMocks();\n  jest.clearAllTimers();\n  jest.useRealTimers();\n});\n\nafterAll(() => {\n  server.close();\n});\n\n// 测试工具函数\nglobal.testUtils = {\n  // 创建Mock用户\n  createMockUser: (overrides = {}) => ({\n    id: 'test-user-id',\n    email: 'test@example.com',\n    username: 'testuser',\n    role: 'USER',\n    status: 'ACTIVE',\n    createdAt: new Date().toISOString(),\n    updatedAt: new Date().toISOString(),\n    ...overrides,\n  }),\n\n  // 创建Mock智能体\n  createMockAgent: (overrides = {}) => ({\n    id: 'test-agent-id',\n    name: 'Test Agent',\n    description: 'Test agent description',\n    systemPrompt: 'You are a test agent',\n    model: 'gpt-3.5-turbo',\n    temperature: 0.7,\n    maxTokens: 1000,\n    isPublic: true,\n    createdBy: 'test-user-id',\n    createdAt: new Date().toISOString(),\n    updatedAt: new Date().toISOString(),\n    ...overrides,\n  }),\n\n  // 创建Mock聊天会话\n  createMockChatSession: (overrides = {}) => ({\n    id: 'test-session-id',\n    title: 'Test Chat Session',\n    userId: 'test-user-id',\n    agentId: 'test-agent-id',\n    createdAt: new Date().toISOString(),\n    updatedAt: new Date().toISOString(),\n    ...overrides,\n  }),\n\n  // 创建Mock API响应\n  createMockApiResponse: (data, status = 200) => ({\n    ok: status >= 200 && status < 300,\n    status,\n    statusText: status === 200 ? 'OK' : 'Error',\n    json: jest.fn().mockResolvedValue(data),\n    text: jest.fn().mockResolvedValue(JSON.stringify(data)),\n    headers: new Map(),\n  }),\n\n  // 等待异步操作\n  waitFor: (ms = 0) => new Promise(resolve => setTimeout(resolve, ms)),\n\n  // 模拟网络延迟\n  simulateNetworkDelay: (min = 100, max = 500) => {\n    const delay = Math.floor(Math.random() * (max - min + 1)) + min;\n    return new Promise(resolve => setTimeout(resolve, delay));\n  },\n\n  createMockSecurityEvent: () => ({\n    id: 'test-event-123',\n    type: 'login_success',\n    severity: 'low',\n    timestamp: new Date(),\n    ip: '192.168.1.100',\n    userId: 'test-user-123',\n    details: {},\n    riskScore: 1,\n    resolved: false,\n  }),\n  \n  sleep: (ms) => new Promise(resolve => setTimeout(resolve, ms)),\n};\n\n// 性能测试工具\nglobal.performanceUtils = {\n  // 测量函数执行时间\n  measureTime: async (fn) => {\n    const start = performance.now();\n    const result = await fn();\n    const end = performance.now();\n    return {\n      result,\n      duration: end - start,\n    };\n  },\n\n  // 内存使用测试\n  measureMemory: () => {\n    if (performance.memory) {\n      return {\n        used: performance.memory.usedJSHeapSize,\n        total: performance.memory.totalJSHeapSize,\n        limit: performance.memory.jsHeapSizeLimit,\n      };\n    }\n    return null;\n  },\n};\n\n// 错误处理增强\nconst originalConsoleError = console.error;\nconsole.error = (...args) => {\n  // 忽略某些预期的测试错误\n  const message = args[0];\n  if (\n    typeof message === 'string' &&\n    (message.includes('Warning: ReactDOM.render is deprecated') ||\n     message.includes('Warning: componentWillReceiveProps has been renamed'))\n  ) {\n    return;\n  }\n  originalConsoleError.apply(console, args);\n};\n\n// 全局测试配置\njest.setTimeout(30000); // 30秒超时\n\n// 移除导致死循环的模块强制加载\n// 注释：原来的 global.beforeAll 中的 require 语句会导致循环引用\n// 这些模块应该在需要时才加载，而不是在全局设置中强制加载\n\nconsole.log('Fixed Jest setup completed - 死循环问题已解决');"],"names":["jest","mock","useRouter","push","fn","replace","back","forward","refresh","prefetch","useSearchParams","get","getAll","has","keys","values","entries","forEach","toString","usePathname","PrismaClient","mockImplementation","$connect","$disconnect","$transaction","$queryRaw","$executeRaw","user","findMany","findUnique","findFirst","create","update","delete","count","agentConfig","chatSession","chatMessage","posterTask","errorLog","usageStats","Prisma","TransactionIsolationLevel","ReadCommitted","ReadUncommitted","RepeatableRead","Serializable","readFile","writeFile","unlink","mkdir","readdir","stat","access","require","TextEncoder","TextDecoder","server","global","process","env","NODE_ENV","DATABASE_URL","JWT_SECRET","NEXTAUTH_SECRET","NEXTAUTH_URL","REDIS_URL","FASTGPT_API_URL","FASTGPT_API_KEY","QWEN_BASE_URL","QWEN_API_KEY","SILICONFLOW_BASE_URL","SILICONFLOW_API_KEY","ENABLE_MOCKS","fetch","console","log","debug","info","warn","error","Object","defineProperty","value","randomUUID","Math","random","substr","getRandomValues","arr","i","length","floor","beforeAll","listen","onUnhandledRequest","afterEach","resetHandlers","clearAllMocks","clearAllTimers","useRealTimers","afterAll","close","testUtils","createMockUser","overrides","id","email","username","role","status","createdAt","Date","toISOString","updatedAt","createMockAgent","name","description","systemPrompt","model","temperature","maxTokens","isPublic","createdBy","createMockChatSession","title","userId","agentId","createMockApiResponse","data","ok","statusText","json","mockResolvedValue","text","JSON","stringify","headers","Map","waitFor","ms","Promise","resolve","setTimeout","simulateNetworkDelay","min","max","delay","createMockSecurityEvent","type","severity","timestamp","ip","details","riskScore","resolved","sleep","performanceUtils","measureTime","start","performance","now","result","end","duration","measureMemory","memory","used","usedJSHeapSize","total","totalJSHeapSize","limit","jsHeapSizeLimit","originalConsoleError","args","message","includes","apply"],"mappings":"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"}