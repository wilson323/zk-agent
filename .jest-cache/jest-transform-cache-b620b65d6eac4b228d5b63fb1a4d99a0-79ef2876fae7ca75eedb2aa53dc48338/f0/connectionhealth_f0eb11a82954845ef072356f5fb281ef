e58ce06301c137ab85d475f7c23f6dfa
/**
 * @file connection-health.js
 * @description 数据库连接健康检查和重连机制
 * @author ZK-Agent Team
 * @date 2025-06-25
 */

const {
  getCurrentConfig
} = require('./database.config');
const {
  Pool
} = require('pg');
const EventEmitter = require('events');

/**
 * 数据库连接健康检查器
 */
class DatabaseHealthChecker extends EventEmitter {
  constructor() {
    super();
    this.pool = null;
    this.isHealthy = false;
    this.reconnectAttempts = 0;
    this.maxReconnectAttempts = 5;
    this.reconnectDelay = 5000; // 5秒
    this.healthCheckInterval = 30000; // 30秒
    this.healthCheckTimer = null;
  }

  /**
   * 初始化数据库连接池
   */
  async initialize() {
    try {
      const config = getCurrentConfig();
      this.pool = new Pool({
        host: config.host,
        port: config.port,
        database: config.database,
        user: config.username,
        password: config.password,
        max: config.pool.max,
        min: config.pool.min,
        idleTimeoutMillis: config.pool.idle,
        connectionTimeoutMillis: config.pool.acquire,
        ssl: config.ssl,
        // 连接重试配置
        retryDelayMs: 1000,
        maxRetries: 3
      });

      // 监听连接池事件
      this.pool.on('connect', client => {
        console.log('数据库连接已建立');
        this.isHealthy = true;
        this.reconnectAttempts = 0;
        this.emit('connected', client);
      });
      this.pool.on('error', err => {
        console.error('数据库连接池错误:', err);
        this.isHealthy = false;
        this.emit('error', err);
        this.handleConnectionError(err);
      });
      this.pool.on('remove', client => {
        console.log('数据库连接已移除');
        this.emit('disconnected', client);
      });

      // 启动健康检查
      this.startHealthCheck();

      // 初始连接测试
      await this.testConnection();
      console.log('数据库连接池初始化成功');
      return this.pool;
    } catch (error) {
      console.error('数据库连接池初始化失败:', error);
      throw error;
    }
  }

  /**
   * 测试数据库连接
   */
  async testConnection() {
    try {
      const client = await this.pool.connect();
      const result = await client.query('SELECT NOW() as current_time');
      client.release();
      this.isHealthy = true;
      console.log('数据库连接测试成功:', result.rows[0].current_time);
      return true;
    } catch (error) {
      this.isHealthy = false;
      console.error('数据库连接测试失败:', error);
      throw error;
    }
  }

  /**
   * 启动健康检查
   */
  startHealthCheck() {
    if (this.healthCheckTimer) {
      clearInterval(this.healthCheckTimer);
    }
    this.healthCheckTimer = setInterval(async () => {
      try {
        await this.testConnection();
        if (!this.isHealthy) {
          console.log('数据库连接已恢复');
          this.isHealthy = true;
          this.emit('recovered');
        }
      } catch (error) {
        if (this.isHealthy) {
          console.error('数据库健康检查失败:', error);
          this.isHealthy = false;
          this.emit('unhealthy', error);
        }
      }
    }, this.healthCheckInterval);
  }

  /**
   * 处理连接错误
   */
  async handleConnectionError(error) {
    if (this.reconnectAttempts >= this.maxReconnectAttempts) {
      console.error('达到最大重连次数，停止重连');
      this.emit('maxReconnectAttemptsReached', error);
      return;
    }
    this.reconnectAttempts++;
    console.log(`尝试重连数据库 (${this.reconnectAttempts}/${this.maxReconnectAttempts})`);
    setTimeout(async () => {
      try {
        await this.testConnection();
        console.log('数据库重连成功');
        this.emit('reconnected');
      } catch (reconnectError) {
        console.error('数据库重连失败:', reconnectError);
        this.handleConnectionError(reconnectError);
      }
    }, this.reconnectDelay * this.reconnectAttempts); // 指数退避
  }

  /**
   * 获取连接池状态
   */
  getPoolStatus() {
    if (!this.pool) {
      return {
        status: 'not_initialized'
      };
    }
    return {
      status: this.isHealthy ? 'healthy' : 'unhealthy',
      totalCount: this.pool.totalCount,
      idleCount: this.pool.idleCount,
      waitingCount: this.pool.waitingCount,
      reconnectAttempts: this.reconnectAttempts,
      maxReconnectAttempts: this.maxReconnectAttempts
    };
  }

  /**
   * 获取连接
   */
  async getConnection() {
    if (!this.pool) {
      throw new Error('数据库连接池未初始化');
    }
    if (!this.isHealthy) {
      throw new Error('数据库连接不健康');
    }
    return await this.pool.connect();
  }

  /**
   * 执行查询
   */
  async query(text, params) {
    if (!this.pool) {
      throw new Error('数据库连接池未初始化');
    }
    if (!this.isHealthy) {
      throw new Error('数据库连接不健康');
    }
    return await this.pool.query(text, params);
  }

  /**
   * 关闭连接池
   */
  async close() {
    if (this.healthCheckTimer) {
      clearInterval(this.healthCheckTimer);
      this.healthCheckTimer = null;
    }
    if (this.pool) {
      await this.pool.end();
      this.pool = null;
    }
    this.isHealthy = false;
    console.log('数据库连接池已关闭');
  }
}

// 单例实例
const healthChecker = new DatabaseHealthChecker();
module.exports = {
  DatabaseHealthChecker,
  healthChecker
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJnZXRDdXJyZW50Q29uZmlnIiwicmVxdWlyZSIsIlBvb2wiLCJFdmVudEVtaXR0ZXIiLCJEYXRhYmFzZUhlYWx0aENoZWNrZXIiLCJjb25zdHJ1Y3RvciIsInBvb2wiLCJpc0hlYWx0aHkiLCJyZWNvbm5lY3RBdHRlbXB0cyIsIm1heFJlY29ubmVjdEF0dGVtcHRzIiwicmVjb25uZWN0RGVsYXkiLCJoZWFsdGhDaGVja0ludGVydmFsIiwiaGVhbHRoQ2hlY2tUaW1lciIsImluaXRpYWxpemUiLCJjb25maWciLCJob3N0IiwicG9ydCIsImRhdGFiYXNlIiwidXNlciIsInVzZXJuYW1lIiwicGFzc3dvcmQiLCJtYXgiLCJtaW4iLCJpZGxlVGltZW91dE1pbGxpcyIsImlkbGUiLCJjb25uZWN0aW9uVGltZW91dE1pbGxpcyIsImFjcXVpcmUiLCJzc2wiLCJyZXRyeURlbGF5TXMiLCJtYXhSZXRyaWVzIiwib24iLCJjbGllbnQiLCJjb25zb2xlIiwibG9nIiwiZW1pdCIsImVyciIsImVycm9yIiwiaGFuZGxlQ29ubmVjdGlvbkVycm9yIiwic3RhcnRIZWFsdGhDaGVjayIsInRlc3RDb25uZWN0aW9uIiwiY29ubmVjdCIsInJlc3VsdCIsInF1ZXJ5IiwicmVsZWFzZSIsInJvd3MiLCJjdXJyZW50X3RpbWUiLCJjbGVhckludGVydmFsIiwic2V0SW50ZXJ2YWwiLCJzZXRUaW1lb3V0IiwicmVjb25uZWN0RXJyb3IiLCJnZXRQb29sU3RhdHVzIiwic3RhdHVzIiwidG90YWxDb3VudCIsImlkbGVDb3VudCIsIndhaXRpbmdDb3VudCIsImdldENvbm5lY3Rpb24iLCJFcnJvciIsInRleHQiLCJwYXJhbXMiLCJjbG9zZSIsImVuZCIsImhlYWx0aENoZWNrZXIiLCJtb2R1bGUiLCJleHBvcnRzIl0sInNvdXJjZXMiOlsiY29ubmVjdGlvbi1oZWFsdGguanMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAZmlsZSBjb25uZWN0aW9uLWhlYWx0aC5qc1xuICogQGRlc2NyaXB0aW9uIOaVsOaNruW6k+i/nuaOpeWBpeW6t+ajgOafpeWSjOmHjei/nuacuuWItlxuICogQGF1dGhvciBaSy1BZ2VudCBUZWFtXG4gKiBAZGF0ZSAyMDI1LTA2LTI1XG4gKi9cblxuY29uc3QgeyBnZXRDdXJyZW50Q29uZmlnIH0gPSByZXF1aXJlKCcuL2RhdGFiYXNlLmNvbmZpZycpO1xuY29uc3QgeyBQb29sIH0gPSByZXF1aXJlKCdwZycpO1xuY29uc3QgRXZlbnRFbWl0dGVyID0gcmVxdWlyZSgnZXZlbnRzJyk7XG5cbi8qKlxuICog5pWw5o2u5bqT6L+e5o6l5YGl5bq35qOA5p+l5ZmoXG4gKi9cbmNsYXNzIERhdGFiYXNlSGVhbHRoQ2hlY2tlciBleHRlbmRzIEV2ZW50RW1pdHRlciB7XG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5wb29sID0gbnVsbDtcbiAgICB0aGlzLmlzSGVhbHRoeSA9IGZhbHNlO1xuICAgIHRoaXMucmVjb25uZWN0QXR0ZW1wdHMgPSAwO1xuICAgIHRoaXMubWF4UmVjb25uZWN0QXR0ZW1wdHMgPSA1O1xuICAgIHRoaXMucmVjb25uZWN0RGVsYXkgPSA1MDAwOyAvLyA156eSXG4gICAgdGhpcy5oZWFsdGhDaGVja0ludGVydmFsID0gMzAwMDA7IC8vIDMw56eSXG4gICAgdGhpcy5oZWFsdGhDaGVja1RpbWVyID0gbnVsbDtcbiAgfVxuXG4gIC8qKlxuICAgKiDliJ3lp4vljJbmlbDmja7lupPov57mjqXmsaBcbiAgICovXG4gIGFzeW5jIGluaXRpYWxpemUoKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGNvbmZpZyA9IGdldEN1cnJlbnRDb25maWcoKTtcbiAgICAgIFxuICAgICAgdGhpcy5wb29sID0gbmV3IFBvb2woe1xuICAgICAgICBob3N0OiBjb25maWcuaG9zdCxcbiAgICAgICAgcG9ydDogY29uZmlnLnBvcnQsXG4gICAgICAgIGRhdGFiYXNlOiBjb25maWcuZGF0YWJhc2UsXG4gICAgICAgIHVzZXI6IGNvbmZpZy51c2VybmFtZSxcbiAgICAgICAgcGFzc3dvcmQ6IGNvbmZpZy5wYXNzd29yZCxcbiAgICAgICAgbWF4OiBjb25maWcucG9vbC5tYXgsXG4gICAgICAgIG1pbjogY29uZmlnLnBvb2wubWluLFxuICAgICAgICBpZGxlVGltZW91dE1pbGxpczogY29uZmlnLnBvb2wuaWRsZSxcbiAgICAgICAgY29ubmVjdGlvblRpbWVvdXRNaWxsaXM6IGNvbmZpZy5wb29sLmFjcXVpcmUsXG4gICAgICAgIHNzbDogY29uZmlnLnNzbCxcbiAgICAgICAgLy8g6L+e5o6l6YeN6K+V6YWN572uXG4gICAgICAgIHJldHJ5RGVsYXlNczogMTAwMCxcbiAgICAgICAgbWF4UmV0cmllczogM1xuICAgICAgfSk7XG5cbiAgICAgIC8vIOebkeWQrOi/nuaOpeaxoOS6i+S7tlxuICAgICAgdGhpcy5wb29sLm9uKCdjb25uZWN0JywgKGNsaWVudCkgPT4ge1xuICAgICAgICBjb25zb2xlLmxvZygn5pWw5o2u5bqT6L+e5o6l5bey5bu656uLJyk7XG4gICAgICAgIHRoaXMuaXNIZWFsdGh5ID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5yZWNvbm5lY3RBdHRlbXB0cyA9IDA7XG4gICAgICAgIHRoaXMuZW1pdCgnY29ubmVjdGVkJywgY2xpZW50KTtcbiAgICAgIH0pO1xuXG4gICAgICB0aGlzLnBvb2wub24oJ2Vycm9yJywgKGVycikgPT4ge1xuICAgICAgICBjb25zb2xlLmVycm9yKCfmlbDmja7lupPov57mjqXmsaDplJnor686JywgZXJyKTtcbiAgICAgICAgdGhpcy5pc0hlYWx0aHkgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5lbWl0KCdlcnJvcicsIGVycik7XG4gICAgICAgIHRoaXMuaGFuZGxlQ29ubmVjdGlvbkVycm9yKGVycik7XG4gICAgICB9KTtcblxuICAgICAgdGhpcy5wb29sLm9uKCdyZW1vdmUnLCAoY2xpZW50KSA9PiB7XG4gICAgICAgIGNvbnNvbGUubG9nKCfmlbDmja7lupPov57mjqXlt7Lnp7vpmaQnKTtcbiAgICAgICAgdGhpcy5lbWl0KCdkaXNjb25uZWN0ZWQnLCBjbGllbnQpO1xuICAgICAgfSk7XG5cbiAgICAgIC8vIOWQr+WKqOWBpeW6t+ajgOafpVxuICAgICAgdGhpcy5zdGFydEhlYWx0aENoZWNrKCk7XG4gICAgICBcbiAgICAgIC8vIOWIneWni+i/nuaOpea1i+ivlVxuICAgICAgYXdhaXQgdGhpcy50ZXN0Q29ubmVjdGlvbigpO1xuICAgICAgXG4gICAgICBjb25zb2xlLmxvZygn5pWw5o2u5bqT6L+e5o6l5rGg5Yid5aeL5YyW5oiQ5YqfJyk7XG4gICAgICByZXR1cm4gdGhpcy5wb29sO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCfmlbDmja7lupPov57mjqXmsaDliJ3lp4vljJblpLHotKU6JywgZXJyb3IpO1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIOa1i+ivleaVsOaNruW6k+i/nuaOpVxuICAgKi9cbiAgYXN5bmMgdGVzdENvbm5lY3Rpb24oKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGNsaWVudCA9IGF3YWl0IHRoaXMucG9vbC5jb25uZWN0KCk7XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBjbGllbnQucXVlcnkoJ1NFTEVDVCBOT1coKSBhcyBjdXJyZW50X3RpbWUnKTtcbiAgICAgIGNsaWVudC5yZWxlYXNlKCk7XG4gICAgICBcbiAgICAgIHRoaXMuaXNIZWFsdGh5ID0gdHJ1ZTtcbiAgICAgIGNvbnNvbGUubG9nKCfmlbDmja7lupPov57mjqXmtYvor5XmiJDlip86JywgcmVzdWx0LnJvd3NbMF0uY3VycmVudF90aW1lKTtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmlzSGVhbHRoeSA9IGZhbHNlO1xuICAgICAgY29uc29sZS5lcnJvcign5pWw5o2u5bqT6L+e5o6l5rWL6K+V5aSx6LSlOicsIGVycm9yKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiDlkK/liqjlgaXlurfmo4Dmn6VcbiAgICovXG4gIHN0YXJ0SGVhbHRoQ2hlY2soKSB7XG4gICAgaWYgKHRoaXMuaGVhbHRoQ2hlY2tUaW1lcikge1xuICAgICAgY2xlYXJJbnRlcnZhbCh0aGlzLmhlYWx0aENoZWNrVGltZXIpO1xuICAgIH1cblxuICAgIHRoaXMuaGVhbHRoQ2hlY2tUaW1lciA9IHNldEludGVydmFsKGFzeW5jICgpID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHRoaXMudGVzdENvbm5lY3Rpb24oKTtcbiAgICAgICAgaWYgKCF0aGlzLmlzSGVhbHRoeSkge1xuICAgICAgICAgIGNvbnNvbGUubG9nKCfmlbDmja7lupPov57mjqXlt7LmgaLlpI0nKTtcbiAgICAgICAgICB0aGlzLmlzSGVhbHRoeSA9IHRydWU7XG4gICAgICAgICAgdGhpcy5lbWl0KCdyZWNvdmVyZWQnKTtcbiAgICAgICAgfVxuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgaWYgKHRoaXMuaXNIZWFsdGh5KSB7XG4gICAgICAgICAgY29uc29sZS5lcnJvcign5pWw5o2u5bqT5YGl5bq35qOA5p+l5aSx6LSlOicsIGVycm9yKTtcbiAgICAgICAgICB0aGlzLmlzSGVhbHRoeSA9IGZhbHNlO1xuICAgICAgICAgIHRoaXMuZW1pdCgndW5oZWFsdGh5JywgZXJyb3IpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSwgdGhpcy5oZWFsdGhDaGVja0ludGVydmFsKTtcbiAgfVxuXG4gIC8qKlxuICAgKiDlpITnkIbov57mjqXplJnor69cbiAgICovXG4gIGFzeW5jIGhhbmRsZUNvbm5lY3Rpb25FcnJvcihlcnJvcikge1xuICAgIGlmICh0aGlzLnJlY29ubmVjdEF0dGVtcHRzID49IHRoaXMubWF4UmVjb25uZWN0QXR0ZW1wdHMpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+i+vuWIsOacgOWkp+mHjei/nuasoeaVsO+8jOWBnOatoumHjei/nicpO1xuICAgICAgdGhpcy5lbWl0KCdtYXhSZWNvbm5lY3RBdHRlbXB0c1JlYWNoZWQnLCBlcnJvcik7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5yZWNvbm5lY3RBdHRlbXB0cysrO1xuICAgIGNvbnNvbGUubG9nKGDlsJ3or5Xph43ov57mlbDmja7lupMgKCR7dGhpcy5yZWNvbm5lY3RBdHRlbXB0c30vJHt0aGlzLm1heFJlY29ubmVjdEF0dGVtcHRzfSlgKTtcbiAgICBcbiAgICBzZXRUaW1lb3V0KGFzeW5jICgpID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHRoaXMudGVzdENvbm5lY3Rpb24oKTtcbiAgICAgICAgY29uc29sZS5sb2coJ+aVsOaNruW6k+mHjei/nuaIkOWKnycpO1xuICAgICAgICB0aGlzLmVtaXQoJ3JlY29ubmVjdGVkJyk7XG4gICAgICB9IGNhdGNoIChyZWNvbm5lY3RFcnJvcikge1xuICAgICAgICBjb25zb2xlLmVycm9yKCfmlbDmja7lupPph43ov57lpLHotKU6JywgcmVjb25uZWN0RXJyb3IpO1xuICAgICAgICB0aGlzLmhhbmRsZUNvbm5lY3Rpb25FcnJvcihyZWNvbm5lY3RFcnJvcik7XG4gICAgICB9XG4gICAgfSwgdGhpcy5yZWNvbm5lY3REZWxheSAqIHRoaXMucmVjb25uZWN0QXR0ZW1wdHMpOyAvLyDmjIfmlbDpgIDpgb9cbiAgfVxuXG4gIC8qKlxuICAgKiDojrflj5bov57mjqXmsaDnirbmgIFcbiAgICovXG4gIGdldFBvb2xTdGF0dXMoKSB7XG4gICAgaWYgKCF0aGlzLnBvb2wpIHtcbiAgICAgIHJldHVybiB7IHN0YXR1czogJ25vdF9pbml0aWFsaXplZCcgfTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgc3RhdHVzOiB0aGlzLmlzSGVhbHRoeSA/ICdoZWFsdGh5JyA6ICd1bmhlYWx0aHknLFxuICAgICAgdG90YWxDb3VudDogdGhpcy5wb29sLnRvdGFsQ291bnQsXG4gICAgICBpZGxlQ291bnQ6IHRoaXMucG9vbC5pZGxlQ291bnQsXG4gICAgICB3YWl0aW5nQ291bnQ6IHRoaXMucG9vbC53YWl0aW5nQ291bnQsXG4gICAgICByZWNvbm5lY3RBdHRlbXB0czogdGhpcy5yZWNvbm5lY3RBdHRlbXB0cyxcbiAgICAgIG1heFJlY29ubmVjdEF0dGVtcHRzOiB0aGlzLm1heFJlY29ubmVjdEF0dGVtcHRzXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiDojrflj5bov57mjqVcbiAgICovXG4gIGFzeW5jIGdldENvbm5lY3Rpb24oKSB7XG4gICAgaWYgKCF0aGlzLnBvb2wpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcign5pWw5o2u5bqT6L+e5o6l5rGg5pyq5Yid5aeL5YyWJyk7XG4gICAgfVxuXG4gICAgaWYgKCF0aGlzLmlzSGVhbHRoeSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCfmlbDmja7lupPov57mjqXkuI3lgaXlurcnKTtcbiAgICB9XG5cbiAgICByZXR1cm4gYXdhaXQgdGhpcy5wb29sLmNvbm5lY3QoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiDmiafooYzmn6Xor6JcbiAgICovXG4gIGFzeW5jIHF1ZXJ5KHRleHQsIHBhcmFtcykge1xuICAgIGlmICghdGhpcy5wb29sKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ+aVsOaNruW6k+i/nuaOpeaxoOacquWIneWni+WMlicpO1xuICAgIH1cblxuICAgIGlmICghdGhpcy5pc0hlYWx0aHkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcign5pWw5o2u5bqT6L+e5o6l5LiN5YGl5bq3Jyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGF3YWl0IHRoaXMucG9vbC5xdWVyeSh0ZXh0LCBwYXJhbXMpO1xuICB9XG5cbiAgLyoqXG4gICAqIOWFs+mXrei/nuaOpeaxoFxuICAgKi9cbiAgYXN5bmMgY2xvc2UoKSB7XG4gICAgaWYgKHRoaXMuaGVhbHRoQ2hlY2tUaW1lcikge1xuICAgICAgY2xlYXJJbnRlcnZhbCh0aGlzLmhlYWx0aENoZWNrVGltZXIpO1xuICAgICAgdGhpcy5oZWFsdGhDaGVja1RpbWVyID0gbnVsbDtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5wb29sKSB7XG4gICAgICBhd2FpdCB0aGlzLnBvb2wuZW5kKCk7XG4gICAgICB0aGlzLnBvb2wgPSBudWxsO1xuICAgIH1cblxuICAgIHRoaXMuaXNIZWFsdGh5ID0gZmFsc2U7XG4gICAgY29uc29sZS5sb2coJ+aVsOaNruW6k+i/nuaOpeaxoOW3suWFs+mXrScpO1xuICB9XG59XG5cbi8vIOWNleS+i+WunuS+i1xuY29uc3QgaGVhbHRoQ2hlY2tlciA9IG5ldyBEYXRhYmFzZUhlYWx0aENoZWNrZXIoKTtcblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gIERhdGFiYXNlSGVhbHRoQ2hlY2tlcixcbiAgaGVhbHRoQ2hlY2tlclxufTsiXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxNQUFNO0VBQUVBO0FBQWlCLENBQUMsR0FBR0MsT0FBTyxDQUFDLG1CQUFtQixDQUFDO0FBQ3pELE1BQU07RUFBRUM7QUFBSyxDQUFDLEdBQUdELE9BQU8sQ0FBQyxJQUFJLENBQUM7QUFDOUIsTUFBTUUsWUFBWSxHQUFHRixPQUFPLENBQUMsUUFBUSxDQUFDOztBQUV0QztBQUNBO0FBQ0E7QUFDQSxNQUFNRyxxQkFBcUIsU0FBU0QsWUFBWSxDQUFDO0VBQy9DRSxXQUFXQSxDQUFBLEVBQUc7SUFDWixLQUFLLENBQUMsQ0FBQztJQUNQLElBQUksQ0FBQ0MsSUFBSSxHQUFHLElBQUk7SUFDaEIsSUFBSSxDQUFDQyxTQUFTLEdBQUcsS0FBSztJQUN0QixJQUFJLENBQUNDLGlCQUFpQixHQUFHLENBQUM7SUFDMUIsSUFBSSxDQUFDQyxvQkFBb0IsR0FBRyxDQUFDO0lBQzdCLElBQUksQ0FBQ0MsY0FBYyxHQUFHLElBQUksQ0FBQyxDQUFDO0lBQzVCLElBQUksQ0FBQ0MsbUJBQW1CLEdBQUcsS0FBSyxDQUFDLENBQUM7SUFDbEMsSUFBSSxDQUFDQyxnQkFBZ0IsR0FBRyxJQUFJO0VB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OUMsaUJBQWlCLEVBQUUsSUFBSSxDQUFDQSxpQkFBaUI7TUFDekNDLG9CQUFvQixFQUFFLElBQUksQ0FBQ0E7SUFDN0IsQ0FBQztFQUNIOztFQUVBO0FBQ0Y7QUFDQTtFQUNFLE1BQU04QyxhQUFhQSxDQUFBLEVBQUc7SUFDcEIsSUFBSSxDQUFDLElBQUksQ0FBQ2pELElBQUksRUFBRTtNQUNkLE1BQU0sSUFBSWtELEtBQUssQ0FBQyxZQUFZLENBQUM7SUFDL0I7SUFFQSxJQUFJLENBQUMsSUFBSSxDQUFDakQsU0FBUyxFQUFFO01BQ25CLE1BQU0sSUFBSWlELEtBQUssQ0FBQyxVQUFVLENBQUM7SUFDN0I7SUFFQSxPQUFPLE1BQU0sSUFBSSxDQUFDbEQsSUFBSSxDQUFDa0MsT0FBTyxDQUFDLENBQUM7RUFDbEM7O0VBRUE7QUFDRjtBQUNBO0VBQ0UsTUFBTUUsS0FBS0EsQ0FBQ2UsSUFBSSxFQUFFQyxNQUFNLEVBQUU7SUFDeEIsSUFBSSxDQUFDLElBQUksQ0FBQ3BELElBQUksRUFBRTtNQUNkLE1BQU0sSUFBSWtELEtBQUssQ0FBQyxZQUFZLENBQUM7SUFDL0I7SUFFQSxJQUFJLENBQUMsSUFBSSxDQUFDakQsU0FBUyxFQUFFO01BQ25CLE1BQU0sSUFBSWlELEtBQUssQ0FBQyxVQUFVLENBQUM7SUFDN0I7SUFFQSxPQUFPLE1BQU0sSUFBSSxDQUFDbEQsSUFBSSxDQUFDb0MsS0FBSyxDQUFDZSxJQUFJLEVBQUVDLE1BQU0sQ0FBQztFQUM1Qzs7RUFFQTtBQUNGO0FBQ0E7RUFDRSxNQUFNQyxLQUFLQSxDQUFBLEVBQUc7SUFDWixJQUFJLElBQUksQ0FBQy9DLGdCQUFnQixFQUFFO01BQ3pCa0MsYUFBYSxDQUFDLElBQUksQ0FBQ2xDLGdCQUFnQixDQUFDO01BQ3BDLElBQUksQ0FBQ0EsZ0JBQWdCLEdBQUcsSUFBSTtJQUM5QjtJQUVBLElBQUksSUFBSSxDQUFDTixJQUFJLEVBQUU7TUFDYixNQUFNLElBQUksQ0FBQ0EsSUFBSSxDQUFDc0QsR0FBRyxDQUFDLENBQUM7TUFDckIsSUFBSSxDQUFDdEQsSUFBSSxHQUFHLElBQUk7SUFDbEI7SUFFQSxJQUFJLENBQUNDLFNBQVMsR0FBRyxLQUFLO0lBQ3RCeUIsT0FBTyxDQUFDQyxHQUFHLENBQUMsV0FBVyxDQUFDO0VBQzFCO0FBQ0Y7O0FBRUE7QUFDQSxNQUFNNEIsYUFBYSxHQUFHLElBQUl6RCxxQkFBcUIsQ0FBQyxDQUFDO0FBRWpEMEQsTUFBTSxDQUFDQyxPQUFPLEdBQUc7RUFDZjNELHFCQUFxQjtFQUNyQnlEO0FBQ0YsQ0FBQyIsImlnbm9yZUxpc3QiOltdfQ==