{"version":3,"names":["fs","require","path","validateJestConfig","config","errors","warnings","jest","safeRequire","configPath","resolve","process","cwd","existsSync","error","push","message","console","log","valid","testEnvironment","setupFilesAfterEnv","length","forEach","setupFile","filePath","replace","preset","transform","extensionsToTreatAsEsm","moduleNameMapper","Object","entries","pattern","replacement","RegExp","includes","testTimeout","collectCoverage","collectCoverageFrom","isValid","validateTestEnvironment","nodeVersion","version","majorVersion","parseInt","slice","split","requiredGlobals","globalName","global","env","NODE_ENV","memoryUsage","heapUsedMB","heapUsed","toFixed","info","platform","arch","modulePath","fallback","warn","createSafePolyfills","polyfills","TextEncoder","TextDecoder","encode","str","buffer","Buffer","from","Uint8Array","decode","toString","isBuffer","fetch","fn","Promise","ok","status","json","text","applySafePolyfills","name","implementation","module","exports"],"sources":["jest-config-validator.js"],"sourcesContent":["/**\n * @file jest-config-validator.js\n * @description Jest configuration validation and error handling utilities\n * @author Jest Fix Team\n */\n\nconst fs = require('fs');\nconst path = require('path');\n\n/**\n * Validate Jest configuration\n * @param {Object} config - Jest configuration object (optional)\n * @returns {Object} Validation result\n */\nfunction validateJestConfig(config = null) {\n  const errors = [];\n  const warnings = [];\n  \n  // Try to get Jest config if not provided\n  if (!config) {\n    try {\n      // Try to get config from jest global or require\n      if (typeof jest !== 'undefined' && jest.config) {\n        config = jest.config;\n      } else {\n        // Try to load config file\n        const fs = safeRequire('fs');\n        const path = safeRequire('path');\n        if (fs && path) {\n          const configPath = path.resolve(process.cwd(), 'jest.config.fixed.js');\n          if (fs.existsSync(configPath)) {\n            config = safeRequire(configPath);\n          }\n        }\n      }\n    } catch (error) {\n      warnings.push(`无法加载 Jest 配置: ${error.message}`);\n    }\n  }\n  \n  // If still no config, create a minimal validation\n  if (!config) {\n    console.log('✅ Jest 配置验证通过 (无法获取配置，跳过详细验证)');\n    return { valid: true, errors: [], warnings: ['无法获取 Jest 配置进行详细验证'] };\n  }\n  \n  // Check required fields\n  if (!config.testEnvironment) {\n    errors.push('testEnvironment is required');\n  }\n  \n  if (!config.setupFilesAfterEnv || config.setupFilesAfterEnv.length === 0) {\n    warnings.push('setupFilesAfterEnv is recommended for proper test setup');\n  }\n  \n  // Validate setup files exist\n  if (config.setupFilesAfterEnv) {\n    config.setupFilesAfterEnv.forEach(setupFile => {\n      const filePath = setupFile.replace('<rootDir>', process.cwd());\n      if (!fs.existsSync(filePath)) {\n        errors.push(`Setup file not found: ${setupFile}`);\n      }\n    });\n  }\n  \n  // Check for conflicting configurations\n  if (config.preset && config.transform) {\n    warnings.push('Both preset and transform are defined - this may cause conflicts');\n  }\n  \n  if (config.preset === 'ts-jest' && config.extensionsToTreatAsEsm) {\n    warnings.push('ts-jest preset with ESM extensions may cause issues');\n  }\n  \n  // Validate module name mappings\n  if (config.moduleNameMapper) {\n    Object.entries(config.moduleNameMapper).forEach(([pattern, replacement]) => {\n      try {\n        new RegExp(pattern);\n      } catch (error) {\n        errors.push(`Invalid regex pattern in moduleNameMapper: ${pattern}`);\n      }\n      \n      if (replacement.includes('<rootDir>')) {\n        const filePath = replacement.replace('<rootDir>', process.cwd());\n        if (!fs.existsSync(filePath) && !replacement.includes('identity-obj-proxy')) {\n          warnings.push(`Mapped file may not exist: ${replacement}`);\n        }\n      }\n    });\n  }\n  \n  // Check test timeout\n  if (config.testTimeout && config.testTimeout < 5000) {\n    warnings.push('testTimeout is very low - tests may fail due to timeout');\n  }\n  \n  if (config.testTimeout && config.testTimeout > 60000) {\n    warnings.push('testTimeout is very high - this may slow down test execution');\n  }\n  \n  // Validate coverage configuration\n  if (config.collectCoverage && !config.collectCoverageFrom) {\n    warnings.push('collectCoverage is enabled but collectCoverageFrom is not specified');\n  }\n  \n  return {\n    isValid: errors.length === 0,\n    errors,\n    warnings,\n  };\n}\n\n/**\n * Validate test environment setup\n * @returns {Object} Validation result\n */\nfunction validateTestEnvironment() {\n  const errors = [];\n  const warnings = [];\n  \n  // Check Node.js version\n  const nodeVersion = process.version;\n  const majorVersion = parseInt(nodeVersion.slice(1).split('.')[0]);\n  \n  if (majorVersion < 16) {\n    errors.push(`Node.js version ${nodeVersion} is not supported. Please use Node.js 16 or higher.`);\n  }\n  \n  // Check required globals\n  const requiredGlobals = ['TextEncoder', 'TextDecoder'];\n  requiredGlobals.forEach(globalName => {\n    if (typeof global[globalName] === 'undefined') {\n      warnings.push(`Global ${globalName} is not defined`);\n    }\n  });\n  \n  // Check Jest environment\n  if (process.env.NODE_ENV !== 'test') {\n    warnings.push('NODE_ENV is not set to \"test\"');\n  }\n  \n  // Check memory usage\n  const memoryUsage = process.memoryUsage();\n  const heapUsedMB = memoryUsage.heapUsed / 1024 / 1024;\n  \n  if (heapUsedMB > 500) {\n    warnings.push(`High memory usage detected: ${heapUsedMB.toFixed(2)}MB`);\n  }\n  \n  return {\n    isValid: errors.length === 0,\n    errors,\n    warnings,\n    info: {\n      nodeVersion,\n      memoryUsage: `${heapUsedMB.toFixed(2)}MB`,\n      platform: process.platform,\n      arch: process.arch,\n    },\n  };\n}\n\n/**\n * Safe require with error handling\n * @param {string} modulePath - Module path to require\n * @param {*} fallback - Fallback value if require fails\n * @returns {*} Required module or fallback\n */\nfunction safeRequire(modulePath, fallback = null) {\n  try {\n    return require(modulePath);\n  } catch (error) {\n    console.warn(`Failed to require ${modulePath}:`, error.message);\n    return fallback;\n  }\n}\n\n/**\n * Create safe global polyfills\n */\nfunction createSafePolyfills() {\n  const polyfills = {};\n  \n  // TextEncoder/TextDecoder polyfills\n  try {\n    const { TextEncoder, TextDecoder } = require('util');\n    polyfills.TextEncoder = TextEncoder;\n    polyfills.TextDecoder = TextDecoder;\n  } catch (error) {\n    console.warn('Failed to load TextEncoder/TextDecoder from util:', error.message);\n    \n    // Fallback implementations\n    polyfills.TextEncoder = class TextEncoder {\n      encode(str) {\n        try {\n          const buffer = Buffer.from(str, 'utf8');\n          return new Uint8Array(buffer);\n        } catch (error) {\n          console.error('TextEncoder fallback failed:', error);\n          return new Uint8Array(0);\n        }\n      }\n    };\n    \n    polyfills.TextDecoder = class TextDecoder {\n      decode(buffer) {\n        try {\n          if (buffer instanceof Uint8Array) {\n            return Buffer.from(buffer).toString('utf8');\n          } else if (Buffer.isBuffer(buffer)) {\n            return buffer.toString('utf8');\n          } else {\n            return Buffer.from(buffer).toString('utf8');\n          }\n        } catch (error) {\n          console.error('TextDecoder fallback failed:', error);\n          return '';\n        }\n      }\n    };\n  }\n  \n  // Fetch polyfill\n  if (typeof global.fetch === 'undefined') {\n    polyfills.fetch = jest.fn(() => \n      Promise.resolve({\n        ok: true,\n        status: 200,\n        json: () => Promise.resolve({}),\n        text: () => Promise.resolve(''),\n      })\n    );\n  }\n  \n  return polyfills;\n}\n\n/**\n * Apply polyfills safely to global scope\n * @param {Object} polyfills - Polyfills to apply\n */\nfunction applySafePolyfills(polyfills) {\n  try {\n    Object.entries(polyfills).forEach(([name, implementation]) => {\n      try {\n        if (typeof global[name] === 'undefined') {\n          global[name] = implementation;\n          console.log(`✓ Applied polyfill for ${name}`);\n        } else {\n          console.log(`✓ ${name} already exists, skipping polyfill`);\n        }\n      } catch (error) {\n        console.error(`✗ Failed to apply polyfill for ${name}:`, error.message);\n      }\n    });\n  } catch (error) {\n    console.error('应用 polyfills 时发生错误:', error.message);\n  }\n}\n\nmodule.exports = {\n  validateJestConfig,\n  validateTestEnvironment,\n  safeRequire,\n  createSafePolyfills,\n  applySafePolyfills,\n};"],"mappings":"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","ignoreList":[]}