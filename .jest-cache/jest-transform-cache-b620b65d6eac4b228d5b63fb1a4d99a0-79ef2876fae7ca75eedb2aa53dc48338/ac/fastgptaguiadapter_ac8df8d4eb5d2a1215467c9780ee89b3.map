{"version":3,"names":["cov_2qei6htqzu","actualCoverage","s","server_1","require","fastgpt_1","image_generator_1","fastgptTools","name","description","execute","params","f","appId","variables","initChatSession","chatId","content","streamCallback","sendChatMessage","getHistoryMessages","includeWelcome","b","history","generateImageFromChat","messageId","rating","comment","response","fetch","method","headers","body","JSON","stringify","json","messages","targets","FastGptAgUiAdapter","constructor","threadId","runId","runtime","AgentRuntime","tools","result","runTool","updateState","sendMessage","state","getState","Error","push","role","reply","getHistory","generateImage","submitFeedback","batchForward","exports"],"sources":["E:\\zk-agent\\lib\\api\\fastgpt-ag-ui-adapter.ts"],"sourcesContent":["// @ts-nocheck\nimport { AgentRuntime, type AgentState, type ToolDefinition } from \"@ag-ui/server\"\nimport { initChatSession, sendChatMessage, getHistoryMessages } from \"./fastgpt\"\nimport { generateImageFromChat } from \"../utils/image-generator\"\n\n// FastGPT工具定义\nconst fastgptTools: ToolDefinition[] = [\n  {\n    name: \"init_chat_session\",\n    description: \"初始化FastGPT聊天会话\",\n    execute: async (params: { appId: string; variables?: Record<string, string> }) => {\n      const { appId, variables } = params\n      return await initChatSession(appId, variables)\n    },\n  },\n  {\n    name: \"send_message\",\n    description: \"发送消息到FastGPT\",\n    execute: async (params: {\n      chatId: string\n      content: string\n      variables?: Record<string, string>\n      streamCallback?: (chunk: string) => void\n    }) => {\n      const { chatId, content, variables, streamCallback } = params\n      return await sendChatMessage(chatId, content, variables, streamCallback)\n    },\n  },\n  {\n    name: \"get_history\",\n    description: \"获取FastGPT历史消息\",\n    execute: async (params: { chatId: string }) => {\n      const { chatId } = params\n      return await getHistoryMessages(chatId)\n    },\n  },\n  {\n    name: \"generate_image\",\n    description: \"从聊天记录生成长图\",\n    execute: async (params: { chatId: string; includeWelcome?: boolean }) => {\n      const { chatId, includeWelcome = true } = params\n      const history = await getHistoryMessages(chatId)\n      return await generateImageFromChat(history, includeWelcome)\n    },\n  },\n  {\n    name: \"feedback\",\n    description: \"提交反馈（点赞/点踩）\",\n    execute: async (params: { messageId: string; rating: \"like\" | \"dislike\"; comment?: string }) => {\n      const { messageId, rating, comment } = params\n      // 实现点赞/点踩功能\n      const response = await fetch(\"/api/fastgpt/feedback\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ messageId, rating, comment }),\n      })\n      return await response.json()\n    },\n  },\n  {\n    name: \"batch_forward\",\n    description: \"批量转发消息\",\n    execute: async (params: { messages: string[]; targets: string[] }) => {\n      const { messages, targets } = params\n      // 实现批量转发功能\n      const response = await fetch(\"/api/fastgpt/batch-forward\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ messages, targets }),\n      })\n      return await response.json()\n    },\n  },\n]\n\n// 创建FastGPT AG-UI适配器\nexport class FastGptAgUiAdapter {\n  private runtime: AgentRuntime\n\n  constructor(threadId: string, runId: string) {\n    this.runtime = new AgentRuntime({\n      threadId,\n      runId,\n      tools: fastgptTools,\n    })\n  }\n\n  // 初始化聊天会话\n  async initChatSession(appId: string, variables?: Record<string, string>): Promise<any> {\n    const result = await this.runtime.runTool(\"init_chat_session\", { appId, variables })\n    this.runtime.updateState({ chatId: result.chatId, appId, variables })\n    return result\n  }\n\n  // 发送消息\n  async sendMessage(content: string, streamCallback?: (chunk: string) => void): Promise<any> {\n    const state = this.runtime.getState() as AgentState & { chatId: string; variables?: Record<string, string> }\n    if (!state.chatId) {\n      throw new Error(\"聊天会话未初始化\")\n    }\n\n    const result = await this.runtime.runTool(\"send_message\", {\n      chatId: state.chatId,\n      content,\n      variables: state.variables,\n      streamCallback,\n    })\n\n    // 更新状态，保存最新消息\n    const messages = state.messages || []\n    messages.push(\n      {\n        role: \"user\",\n        content,\n      },\n      {\n        role: \"assistant\",\n        content: result.reply,\n      },\n    )\n\n    this.runtime.updateState({ messages })\n    return result\n  }\n\n  // 获取历史消息\n  async getHistory(): Promise<any> {\n    const state = this.runtime.getState() as AgentState & { chatId: string }\n    if (!state.chatId) {\n      throw new Error(\"聊天会话未初始化\")\n    }\n\n    const result = await this.runtime.runTool(\"get_history\", { chatId: state.chatId })\n    this.runtime.updateState({ messages: result.messages })\n    return result\n  }\n\n  // 生成长图\n  async generateImage(includeWelcome = true): Promise<any> {\n    const state = this.runtime.getState() as AgentState & { chatId: string }\n    if (!state.chatId) {\n      throw new Error(\"聊天会话未初始化\")\n    }\n\n    return await this.runtime.runTool(\"generate_image\", {\n      chatId: state.chatId,\n      includeWelcome,\n    })\n  }\n\n  // 提交反馈\n  async submitFeedback(messageId: string, rating: \"like\" | \"dislike\", comment?: string): Promise<any> {\n    return await this.runtime.runTool(\"feedback\", { messageId, rating, comment })\n  }\n\n  // 批量转发\n  async batchForward(messages: string[], targets: string[]): Promise<any> {\n    return await this.runtime.runTool(\"batch_forward\", { messages, targets })\n  }\n\n  // 获取当前状态\n  getState(): AgentState {\n    return this.runtime.getState()\n  }\n}\n"],"mappings":"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","ignoreList":[]}