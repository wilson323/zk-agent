{"version":3,"names":["cov_tmia3mzuo","path","hash","global","Function","gcv","coverageData","statementMap","start","line","column","end","fnMap","name","decl","loc","branchMap","type","locations","undefined","s","f","b","inputSourceMap","file","mappings","names","sources","sourcesContent","version","_coverageSchema","coverage","actualCoverage","api_route_wrapper_1","require","api_helper_1","core_1","path_1","uuid_1","exports","POST","createApiRoute","RouteConfigs","protectedPost","req","params","validatedBody","validatedQuery","user","requestId","formData","get","ApiResponseWrapper","error","ErrorCode","VALIDATION_ERROR","fileType","split","pop","toLowerCase","allowedTypes","includes","maxSize","size","uniqueId","v4","fileName","uploadDir","join","process","cwd","bytes","arrayBuffer","buffer","Buffer","from","success","uploadedAt","Date","toISOString","id","console","INTERNAL_SERVER_ERROR"],"sources":["E:\\zk-agent\\app\\api\\cad\\upload\\route.ts"],"sourcesContent":["/**\n * @file cad\\upload\\route.ts\n * @description Migrated API route with global error handling\n * @author ZK-Agent Team\n * @date 2025-06-25\n */\n\ndeclare module 'uuid';\n\nimport { NextRequest } from 'next/server';\nimport { createApiRoute, RouteConfigs } from '@/lib/middleware/api-route-wrapper';\nimport { ApiResponseWrapper } from '@/lib/utils/api-helper';\nimport { ErrorCode } from '@/types/core';\nimport { join } from \"path\";\nimport { v4 as uuidv4 } from \"uuid\";\n\nexport const POST = createApiRoute(\n  RouteConfigs.protectedPost(),\n  async (req: NextRequest, { params, validatedBody, validatedQuery, user, requestId }) => {\n    try {\n      const formData = await req.formData();\n      const file = formData.get(\"file\") as File;\n  \n      if (!file) {\n        return ApiResponseWrapper.error(ErrorCode.VALIDATION_ERROR, \"未找到文件\", null);\n      }\n  \n      // 检查文件类型\n      const fileType = file.name.split(\".\").pop()?.toLowerCase();\n      const allowedTypes = [\"dxf\", \"dwg\", \"step\", \"stp\", \"iges\", \"igs\"];\n  \n      if (!fileType || !allowedTypes.includes(fileType)) {\n        return ApiResponseWrapper.error(ErrorCode.VALIDATION_ERROR, \"不支持的文件类型\", null);\n      }\n  \n      // 检查文件大小（最大50MB）\n      const maxSize = 50 * 1024 * 1024;\n      if (file.size > maxSize) {\n        return ApiResponseWrapper.error(ErrorCode.VALIDATION_ERROR, \"文件过大，最大允许50MB\", null);\n      }\n  \n      // 生成唯一文件名\n      const uniqueId = uuidv4();\n      const fileName = `${uniqueId}-${file.name}`;\n  \n      // 创建上传目录（如果不存在）\n      const uploadDir = join(process.cwd(), \"uploads\");\n  \n      try {\n        // 将文件保存到服务器（在实际生产环境中，您可能会使用云存储服务）\n        const bytes = await file.arrayBuffer();\n        const buffer = Buffer.from(bytes);\n  \n        // 注意：在Vercel等无状态环境中，这种本地文件存储方式不适用\n        // 实际应用中应使用S3、Azure Blob Storage等云存储服务\n        // 这里仅作为示例\n        // await writeFile(join(uploadDir, fileName), buffer)\n  \n        // 模拟CAD文件解析\n        // 在实际应用中，您需要使用专门的CAD解析库\n  \n        // 返回解析结果\n        return ApiResponseWrapper.success({\n          success: true,\n          name: file.name,\n          type: file.type,\n          size: file.size,\n          uploadedAt: new Date().toISOString(),\n          id: uniqueId,\n          // 这里可以添加更多解析结果\n        });\n      } catch (error) {\n        console.error('文件上传失败:', error);\n        return ApiResponseWrapper.error(\n          ErrorCode.INTERNAL_SERVER_ERROR,\n          \"文件上传失败\",\n          null,\n          500\n        );\n      }\n    } catch (error) {\n      console.error('处理请求失败:', error);\n      return ApiResponseWrapper.error(\n        ErrorCode.INTERNAL_SERVER_ERROR,\n        \"处理请求失败\",\n        null,\n        500\n      );\n    }\n  }\n);"],"mappings":";;AAAA;;;;;;AAAA;AAAA,SAAAA,cAAA;EAAA,IAAAC,IAAA;EAAA,IAAAC,IAAA;EAAA,IAAAC,MAAA,OAAAC,QAAA;EAAA,IAAAC,GAAA;EAAA,IAAAC,YAAA;IAAAL,IAAA;IAAAM,YAAA;MAAA;QAAAC,KAAA;UAAAC,IAAA;UAAAC,MAAA;QAAA;QAAAC,GAAA;UAAAF,IAAA;UAAAC,MAAA;QAAA;MAAA;MAAA;QAAAF,KAAA;UAAAC,IAAA;UAAAC,MAAA;QAAA;QAAAC,GAAA;UAAAF,IAAA;UAAAC,MAAA;QAAA;MAAA;MAAA;QAAAF,KAAA;UAAAC,IAAA;UAAAC,MAAA;QAAA;QAAAC,GAAA;UAAAF,IAAA;UAAAC,MAAA;QAAA;MAAA;MAAA;QAAAF,KAAA;UAAAC,IAAA;UAAAC,MAAA;QAAA;QAAAC,GAAA;UAAAF,IAAA;UAAAC,MAAA;QAAA;MAAA;MAAA;QAAAF,KAAA;UAAAC,IAAA;UAAAC,MAAA;QAAA;QAAAC,GAAA;UAAAF,IAAA;UAAAC,MAAA;QAAA;MAAA;MAAA;QAAAF,KAAA;UAAAC,IAAA;UAAAC,MAAA;QAAA;QAAAC,GAAA;UAAAF,IAAA;UAAAC,MAAA;QAAA;MAAA;MAAA;QAAAF,KAAA;UAAAC,IAAA;UAAAC,MAAA;QAAA;QAAAC,GAAA;UAAAF,IAAA;UAAAC,MAAA;QAAA;MAAA;MAAA;QAAAF,KAAA;UAAAC,IAAA;UAAAC,MAAA;QAAA;QAAAC,GAAA;UAAAF,IAAA;UAAAC,MAAA;QAAA;MAAA;MAAA;QAAAF,KAAA;UAAAC,IAAA;UAAAC,MAAA;QAAA;QAAAC,GAAA;UAAAF,IAAA;UAAAC,MAAA;QAAA;MAAA;MAAA;QAAAF,KAAA;UAAAC,IAAA;UAAAC,MAAA;QAAA;QAAAC,GAAA;UAAAF,IAAA;UAAAC,MAAA;QAAA;MAAA;MAAA;QAAAF,KAAA;UAAAC,IAAA;UAAAC,MAAA;QAAA;QAAAC,GAAA;UAAAF,IAAA;UAAAC,MAAA;QAAA;MAAA;MAAA;QAAAF,KAAA;UAAAC,IAAA;UAAAC,MAAA;QAAA;QAAAC,GAAA;UAAAF,IAAA;UAAAC,MAAA;QAAA;MAAA;MAAA;QAAAF,KAAA;UAAAC,IAAA;UAAAC,MAAA;QAAA;QAAAC,GAAA;UAAAF,IAAA;UAAAC,MAAA;QAAA;MAAA;MAAA;QAAAF,KAAA;UAAAC,IAAA;UAAAC,MAAA;QAAA;QAAAC,GAAA;UAAAF,IAAA;UAAAC,MAAA;QAAA;MAAA;MAAA;QAAAF,KAAA;UAAAC,IAAA;UAAAC,MAAA;QAAA;QAAAC,GAAA;UAAAF,IAAA;UAAAC,MAAA;QAAA;MAAA;MAAA;QAAAF,KAAA;UAAAC,IAAA;UAAAC,MAAA;QAAA;QAAAC,GAAA;UAAAF,IAAA;UAAAC,MAAA;QAAA;MAAA;MAAA;QAAAF,KAAA;UAAAC,IAAA;UAAAC,MAAA;QAAA;QAAAC,GAAA;UAAAF,IAAA;UAAAC,MAAA;QAAA;MAAA;MAAA;QAAAF,KAAA;UAAAC,IAAA;UAAAC,MAAA;QAAA;QAAAC,GAAA;UAAAF,IAAA;UAAAC,MAAA;QAAA;MAAA;MAAA;QAAAF,KAAA;UAAAC,IAAA;UAAAC,MAAA;QAAA;QAAAC,GAAA;UAAAF,IAAA;UAAAC,MAAA;QAAA;MAAA;MAAA;QAAAF,KAAA;UAAAC,IAAA;UAAAC,MAAA;QAAA;QAAAC,GAAA;UAAAF,IAAA;UAAAC,MAAA;QAAA;MAAA;MAAA;QAAAF,KAAA;UAAAC,IAAA;UAAAC,MAAA;QAAA;QAAAC,GAAA;UAAAF,IAAA;UAAAC,MAAA;QAAA;MAAA;MAAA;QAAAF,KAAA;UAAAC,IAAA;UAAAC,MAAA;QAAA;QAAAC,GAAA;UAAAF,IAAA;UAAAC,MAAA;QAAA;MAAA;MAAA;QAAAF,KAAA;UAAAC,IAAA;UAAAC,MAAA;QAAA;QAAAC,GAAA;UAAAF,IAAA;UAAAC,MAAA;QAAA;MAAA;MAAA;QAAAF,KAAA;UAAAC,IAAA;UAAAC,MAAA;QAAA;QAAAC,GAAA;UAAAF,IAAA;UAAAC,MAAA;QAAA;MAAA;MAAA;QAAAF,KAAA;UAAAC,IAAA;UAAAC,MAAA;QAAA;QAAAC,GAAA;UAAAF,IAAA;UAAAC,MAAA;QAAA;MAAA;MAAA;QAAAF,KAAA;UAAAC,IAAA;UAAAC,MAAA;QAAA;QAAAC,GAAA;UAAAF,IAAA;UAAAC,MAAA;QAAA;MAAA;MAAA;QAAAF,KAAA;UA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","ignoreList":[]}