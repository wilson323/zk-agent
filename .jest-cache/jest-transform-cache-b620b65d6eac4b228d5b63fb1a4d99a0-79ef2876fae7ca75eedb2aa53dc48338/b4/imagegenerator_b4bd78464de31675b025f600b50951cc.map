{"version":3,"names":["cov_2jtli5tiv6","actualCoverage","exports","generateImageFromChat","canvas_1","s","require","path_1","__importDefault","promises_1","os_1","messages","includeWelcome","b","f","registerFont","default","join","process","cwd","family","error","console","warn","width","messageHeight","welcomeHeight","height","length","canvas","createCanvas","ctx","getContext","fillStyle","fillRect","mascotImage","loadImage","imgWidth","imgHeight","drawImage","font","textAlign","fillText","y","message","isUser","role","maxWidth","words","content","split","line","lineY","word","testLine","metrics","measureText","timestamp","date","Date","timeStr","toLocaleString","tempDir","tmpdir","mkdir","recursive","fileName","now","filePath","buffer","toBuffer","writeFile","imageUrl"],"sources":["E:\\zk-agent\\lib\\utils\\image-generator.ts"],"sourcesContent":["// @ts-nocheck\nimport { createCanvas, loadImage, registerFont } from \"canvas\"\nimport path from \"path\"\nimport fs from \"fs/promises\"\nimport os from \"os\"\n\ninterface ChatMessage {\n  role: \"user\" | \"assistant\" | \"system\"\n  content: string\n  timestamp?: number\n}\n\nexport async function generateImageFromChat(\n  messages: ChatMessage[],\n  includeWelcome = true,\n): Promise<{ imageUrl: string }> {\n  // 注册字体\n  try {\n    registerFont(path.join(process.cwd(), \"public\", \"fonts\", \"NotoSansSC-Regular.otf\"), {\n      family: \"Noto Sans SC\",\n    })\n  } catch (error) {\n    console.warn(\"无法注册字体:\", error)\n  }\n\n  // 创建画布\n  const width = 800\n  const messageHeight = 150 // 每条消息的高度\n  const welcomeHeight = includeWelcome ? 300 : 0 // 欢迎界面的高度\n  const height = welcomeHeight + messages.length * messageHeight\n\n  const canvas = createCanvas(width, height)\n  const ctx = canvas.getContext(\"2d\")\n\n  // 设置背景\n  ctx.fillStyle = \"#f5f5f5\"\n  ctx.fillRect(0, 0, width, height)\n\n  // 绘制欢迎界面\n  if (includeWelcome) {\n    ctx.fillStyle = \"#ffffff\"\n    ctx.fillRect(0, 0, width, welcomeHeight)\n\n    try {\n      // 加载牛牛动画图片\n      const mascotImage = await loadImage(path.join(process.cwd(), \"public\", \"images\", \"zkteco-mascot.png\"))\n      const imgWidth = 200\n      const imgHeight = (mascotImage.height / mascotImage.width) * imgWidth\n      ctx.drawImage(mascotImage, (width - imgWidth) / 2, 50, imgWidth, imgHeight)\n\n      // 绘制欢迎文字\n      ctx.font = '24px \"Noto Sans SC\"'\n      ctx.fillStyle = \"#333333\"\n      ctx.textAlign = \"center\"\n      ctx.fillText(\"欢迎使用ZKTeco AI智能对话系统\", width / 2, welcomeHeight - 50)\n    } catch (error) {\n      console.error(\"加载图片失败:\", error)\n      // 如果图片加载失败，绘制备用文字\n      ctx.font = '24px \"Noto Sans SC\"'\n      ctx.fillStyle = \"#333333\"\n      ctx.textAlign = \"center\"\n      ctx.fillText(\"欢迎使用ZKTeco AI智能对话系统\", width / 2, welcomeHeight / 2)\n    }\n  }\n\n  // 绘制消息\n  let y = welcomeHeight\n  for (const message of messages) {\n    const isUser = message.role === \"user\"\n\n    // 设置消息背景\n    ctx.fillStyle = isUser ? \"#e1f5fe\" : \"#ffffff\"\n    ctx.fillRect(0, y, width, messageHeight)\n\n    // 绘制角色标识\n    ctx.font = '16px \"Noto Sans SC\"'\n    ctx.fillStyle = \"#666666\"\n    ctx.textAlign = \"left\"\n    ctx.fillText(isUser ? \"用户\" : \"助手\", 20, y + 30)\n\n    // 绘制消息内容\n    ctx.font = '18px \"Noto Sans SC\"'\n    ctx.fillStyle = \"#333333\"\n\n    // 简单的文本换行处理\n    const maxWidth = width - 40\n    const words = message.content.split(\" \")\n    let line = \"\"\n    let lineY = y + 60\n\n    for (const word of words) {\n      const testLine = line + word + \" \"\n      const metrics = ctx.measureText(testLine)\n\n      if (metrics.width > maxWidth && line !== \"\") {\n        ctx.fillText(line, 20, lineY)\n        line = word + \" \"\n        lineY += 24\n      } else {\n        line = testLine\n      }\n    }\n    ctx.fillText(line, 20, lineY)\n\n    // 绘制时间戳\n    if (message.timestamp) {\n      const date = new Date(message.timestamp)\n      const timeStr = date.toLocaleString()\n      ctx.font = '14px \"Noto Sans SC\"'\n      ctx.fillStyle = \"#999999\"\n      ctx.textAlign = \"right\"\n      ctx.fillText(timeStr, width - 20, y + messageHeight - 20)\n    }\n\n    y += messageHeight\n  }\n\n  // 保存图片到临时文件\n  const tempDir = path.join(os.tmpdir(), \"zkteco-chat-images\")\n  await fs.mkdir(tempDir, { recursive: true })\n\n  const fileName = `chat_${Date.now()}.png`\n  const filePath = path.join(tempDir, fileName)\n\n  const buffer = canvas.toBuffer(\"image/png\")\n  await fs.writeFile(filePath, buffer)\n\n  // 返回图片URL\n  return {\n    imageUrl: `/api/images/temp/${fileName}`,\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}