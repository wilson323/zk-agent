054df0f4b865f5993405af5a24bb1b50
"use strict";
/**
 * 数据库服务测试
 * 测试database/index.ts中的DatabaseService类
 */
Object.defineProperty(exports, "__esModule", { value: true });
// Mock Prisma Client
jest.mock('@prisma/client');
const index_1 = require("@/lib/database/index");
const client_1 = require("@prisma/client");
const mockPrismaInstance = {
    $connect: jest.fn(),
    $disconnect: jest.fn(),
    $queryRaw: jest.fn(),
    $transaction: jest.fn(),
};
client_1.PrismaClient.mockImplementation(() => mockPrismaInstance);
// Mock console methods
const consoleSpy = {
    log: jest.spyOn(console, 'log').mockImplementation(),
    error: jest.spyOn(console, 'error').mockImplementation(),
};
describe('DatabaseService', () => {
    beforeEach(() => {
        jest.clearAllMocks();
        consoleSpy.log.mockClear();
        consoleSpy.error.mockClear();
    });
    afterAll(() => {
        consoleSpy.log.mockRestore();
        consoleSpy.error.mockRestore();
    });
    describe('getInstance', () => {
        it('应该返回Prisma客户端实例', () => {
            const instance = index_1.DatabaseService.getInstance();
            expect(instance).toBeDefined();
            expect(client_1.PrismaClient).toHaveBeenCalled();
        });
        it('应该返回相同的实例（单例模式）', () => {
            const instance1 = index_1.DatabaseService.getInstance();
            const instance2 = index_1.DatabaseService.getInstance();
            expect(instance1).toBe(instance2);
        });
    });
    describe('connect', () => {
        it('应该成功连接数据库', async () => {
            mockPrismaInstance.$connect.mockResolvedValue(undefined);
            await index_1.DatabaseService.connect();
            expect(mockPrismaInstance.$connect).toHaveBeenCalled();
            expect(consoleSpy.log).toHaveBeenCalledWith('✅ Database connected successfully');
        });
        it('应该处理连接失败的情况', async () => {
            const error = new Error('Connection failed');
            mockPrismaInstance.$connect.mockRejectedValue(error);
            await expect(index_1.DatabaseService.connect()).rejects.toThrow('Connection failed');
            expect(consoleSpy.error).toHaveBeenCalledWith('❌ Database connection failed:', error);
        });
    });
    describe('disconnect', () => {
        it('应该成功断开数据库连接', async () => {
            mockPrismaInstance.$disconnect.mockResolvedValue(undefined);
            await index_1.DatabaseService.disconnect();
            expect(mockPrismaInstance.$disconnect).toHaveBeenCalled();
            expect(consoleSpy.log).toHaveBeenCalledWith('✅ Database disconnected successfully');
        });
        it('应该处理断开连接失败的情况', async () => {
            const error = new Error('Disconnection failed');
            mockPrismaInstance.$disconnect.mockRejectedValue(error);
            await expect(index_1.DatabaseService.disconnect()).rejects.toThrow('Disconnection failed');
            expect(consoleSpy.error).toHaveBeenCalledWith('❌ Database disconnection failed:', error);
        });
    });
    describe('healthCheck', () => {
        it('应该在数据库健康时返回true', async () => {
            mockPrismaInstance.$queryRaw.mockResolvedValue([{ '1': 1 }]);
            const result = await index_1.DatabaseService.healthCheck();
            expect(result).toBe(true);
            expect(mockPrismaInstance.$queryRaw).toHaveBeenCalled();
        });
        it('应该在数据库不健康时返回false', async () => {
            const error = new Error('Health check failed');
            mockPrismaInstance.$queryRaw.mockRejectedValue(error);
            const result = await index_1.DatabaseService.healthCheck();
            expect(result).toBe(false);
            expect(consoleSpy.error).toHaveBeenCalledWith('❌ Database health check failed:', error);
        });
    });
    describe('runTransaction', () => {
        it('应该成功执行事务', async () => {
            const mockCallback = jest.fn().mockResolvedValue('transaction result');
            mockPrismaInstance.$transaction.mockImplementation((callback) => callback(mockPrismaInstance));
            const result = await index_1.DatabaseService.runTransaction(mockCallback);
            expect(result).toBe('transaction result');
            expect(mockPrismaInstance.$transaction).toHaveBeenCalled();
            expect(mockCallback).toHaveBeenCalledWith(mockPrismaInstance);
        });
        it('应该处理事务执行失败的情况', async () => {
            const error = new Error('Transaction failed');
            const mockCallback = jest.fn().mockRejectedValue(error);
            mockPrismaInstance.$transaction.mockImplementation((callback) => callback(mockPrismaInstance));
            await expect(index_1.DatabaseService.runTransaction(mockCallback)).rejects.toThrow('Transaction failed');
        });
    });
    describe('cleanup', () => {
        it('应该调用disconnect方法', async () => {
            mockPrismaInstance.$disconnect.mockResolvedValue(undefined);
            await (0, index_1.cleanup)();
            expect(mockPrismaInstance.$disconnect).toHaveBeenCalled();
        });
    });
    describe('prisma export', () => {
        it('应该导出prisma实例', () => {
            expect(index_1.prisma).toBeDefined();
            expect(index_1.prisma).toBe(index_1.DatabaseService.getInstance());
        });
    });
});
// 测试进程事件监听器
describe('Process Event Listeners', () => {
    let originalProcess;
    beforeAll(() => {
        originalProcess = global.process;
    });
    afterAll(() => {
        global.process = originalProcess;
    });
    it('应该注册进程退出事件监听器', () => {
        const mockProcess = {
            on: jest.fn(),
        };
        global.process = mockProcess;
        // 重新导入模块以触发事件监听器注册
        jest.resetModules();
        require('@/lib/database/index');
        expect(mockProcess.on).toHaveBeenCalledWith('beforeExit', expect.any(Function));
        expect(mockProcess.on).toHaveBeenCalledWith('SIGINT', expect.any(Function));
        expect(mockProcess.on).toHaveBeenCalledWith('SIGTERM', expect.any(Function));
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiRTpcXHprLWFnZW50XFxfX3Rlc3RzX19cXGxpYlxcZGF0YWJhc2VcXGluZGV4LnRlc3QudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7R0FHRzs7QUFLSCxxQkFBcUI7QUFDckIsSUFBSSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFBO0FBSjNCLGdEQUF1RTtBQUN2RSwyQ0FBNkM7QUFLN0MsTUFBTSxrQkFBa0IsR0FBRztJQUN6QixRQUFRLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtJQUNuQixXQUFXLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtJQUN0QixTQUFTLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtJQUNwQixZQUFZLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtDQUN4QixDQUVBO0FBQUMscUJBQXNELENBQUMsa0JBQWtCLENBQUMsR0FBRyxFQUFFLENBQUMsa0JBQXlCLENBQUMsQ0FBQTtBQUU1Ryx1QkFBdUI7QUFDdkIsTUFBTSxVQUFVLEdBQUc7SUFDakIsR0FBRyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxFQUFFLEtBQUssQ0FBQyxDQUFDLGtCQUFrQixFQUFFO0lBQ3BELEtBQUssRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQyxrQkFBa0IsRUFBRTtDQUN6RCxDQUFBO0FBRUQsUUFBUSxDQUFDLGlCQUFpQixFQUFFLEdBQUcsRUFBRTtJQUMvQixVQUFVLENBQUMsR0FBRyxFQUFFO1FBQ2QsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFBO1FBQ3BCLFVBQVUsQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFLENBQUE7UUFDMUIsVUFBVSxDQUFDLEtBQUssQ0FBQyxTQUFTLEVBQUUsQ0FBQTtJQUM5QixDQUFDLENBQUMsQ0FBQTtJQUVGLFFBQVEsQ0FBQyxHQUFHLEVBQUU7UUFDWixVQUFVLENBQUMsR0FBRyxDQUFDLFdBQVcsRUFBRSxDQUFBO1FBQzVCLFVBQVUsQ0FBQyxLQUFLLENBQUMsV0FBVyxFQUFFLENB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WUFBWSxFQUFFLE1BQU0sQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQTtRQUMvRSxNQUFNLENBQUMsV0FBVyxDQUFDLEVBQUUsQ0FBQyxDQUFDLG9CQUFvQixDQUFDLFFBQVEsRUFBRSxNQUFNLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUE7UUFDM0UsTUFBTSxDQUFDLFdBQVcsQ0FBQyxFQUFFLENBQUMsQ0FBQyxvQkFBb0IsQ0FBQyxTQUFTLEVBQUUsTUFBTSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFBO0lBQzlFLENBQUMsQ0FBQyxDQUFBO0FBQ0osQ0FBQyxDQUFDLENBQUEiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiRTpcXHprLWFnZW50XFxfX3Rlc3RzX19cXGxpYlxcZGF0YWJhc2VcXGluZGV4LnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiDmlbDmja7lupPmnI3liqHmtYvor5VcbiAqIOa1i+ivlWRhdGFiYXNlL2luZGV4LnRz5Lit55qERGF0YWJhc2VTZXJ2aWNl57G7XG4gKi9cblxuaW1wb3J0IHsgRGF0YWJhc2VTZXJ2aWNlLCBwcmlzbWEsIGNsZWFudXAgfSBmcm9tICdAL2xpYi9kYXRhYmFzZS9pbmRleCdcbmltcG9ydCB7IFByaXNtYUNsaWVudCB9IGZyb20gJ0BwcmlzbWEvY2xpZW50J1xuXG4vLyBNb2NrIFByaXNtYSBDbGllbnRcbmplc3QubW9jaygnQHByaXNtYS9jbGllbnQnKVxuXG5jb25zdCBtb2NrUHJpc21hSW5zdGFuY2UgPSB7XG4gICRjb25uZWN0OiBqZXN0LmZuKCksXG4gICRkaXNjb25uZWN0OiBqZXN0LmZuKCksXG4gICRxdWVyeVJhdzogamVzdC5mbigpLFxuICAkdHJhbnNhY3Rpb246IGplc3QuZm4oKSxcbn1cblxuOyhQcmlzbWFDbGllbnQgYXMgamVzdC5Nb2NrZWRDbGFzczx0eXBlb2YgUHJpc21hQ2xpZW50PikubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+IG1vY2tQcmlzbWFJbnN0YW5jZSBhcyBhbnkpXG5cbi8vIE1vY2sgY29uc29sZSBtZXRob2RzXG5jb25zdCBjb25zb2xlU3B5ID0ge1xuICBsb2c6IGplc3Quc3B5T24oY29uc29sZSwgJ2xvZycpLm1vY2tJbXBsZW1lbnRhdGlvbigpLFxuICBlcnJvcjogamVzdC5zcHlPbihjb25zb2xlLCAnZXJyb3InKS5tb2NrSW1wbGVtZW50YXRpb24oKSxcbn1cblxuZGVzY3JpYmUoJ0RhdGFiYXNlU2VydmljZScsICgpID0+IHtcbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgamVzdC5jbGVhckFsbE1vY2tzKClcbiAgICBjb25zb2xlU3B5LmxvZy5tb2NrQ2xlYXIoKVxuICAgIGNvbnNvbGVTcHkuZXJyb3IubW9ja0NsZWFyKClcbiAgfSlcblxuICBhZnRlckFsbCgoKSA9PiB7XG4gICAgY29uc29sZVNweS5sb2cubW9ja1Jlc3RvcmUoKVxuICAgIGNvbnNvbGVTcHkuZXJyb3IubW9ja1Jlc3RvcmUoKVxuICB9KVxuXG4gIGRlc2NyaWJlKCdnZXRJbnN0YW5jZScsICgpID0+IHtcbiAgICBpdCgn5bqU6K+l6L+U5ZueUHJpc21h5a6i5oi356uv5a6e5L6LJywgKCkgPT4ge1xuICAgICAgY29uc3QgaW5zdGFuY2UgPSBEYXRhYmFzZVNlcnZpY2UuZ2V0SW5zdGFuY2UoKVxuICAgICAgZXhwZWN0KGluc3RhbmNlKS50b0JlRGVmaW5lZCgpXG4gICAgICBleHBlY3QoUHJpc21hQ2xpZW50KS50b0hhdmVCZWVuQ2FsbGVkKClcbiAgICB9KVxuXG4gICAgaXQoJ+W6lOivpei/lOWbnuebuOWQjOeahOWunuS+i++8iOWNleS+i+aooeW8j++8iScsICgpID0+IHtcbiAgICAgIGNvbnN0IGluc3RhbmNlMSA9IERhdGFiYXNlU2VydmljZS5nZXRJbnN0YW5jZSgpXG4gICAgICBjb25zdCBpbnN0YW5jZTIgPSBEYXRhYmFzZVNlcnZpY2UuZ2V0SW5zdGFuY2UoKVxuICAgICAgZXhwZWN0KGluc3RhbmNlMSkudG9CZShpbnN0YW5jZTIpXG4gICAgfSlcbiAgfSlcblxuICBkZXNjcmliZSgnY29ubmVjdCcsICgpID0+IHtcbiAgICBpdCgn5bqU6K+l5oiQ5Yqf6L+e5o6l5pWw5o2u5bqTJywgYXN5bmMgKCkgPT4ge1xuICAgICAgbW9ja1ByaXNtYUluc3RhbmNlLiRjb25uZWN0Lm1vY2tSZXNvbHZlZFZhbHVlKHVuZGVmaW5lZClcblxuICAgICAgYXdhaXQgRGF0YWJhc2VTZXJ2aWNlLmNvbm5lY3QoKVxuXG4gICAgICBleHBlY3QobW9ja1ByaXNtYUluc3RhbmNlLiRjb25uZWN0KS50b0hhdmVCZWVuQ2FsbGVkKClcbiAgICAgIGV4cGVjdChjb25zb2xlU3B5LmxvZykudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ+KchSBEYXRhYmFzZSBjb25uZWN0ZWQgc3VjY2Vzc2Z1bGx5JylcbiAgICB9KVxuXG4gICAgaXQoJ+W6lOivpeWkhOeQhui/nuaOpeWksei0peeahOaDheWGtScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGVycm9yID0gbmV3IEVycm9yKCdDb25uZWN0aW9uIGZhaWxlZCcpXG4gICAgICBtb2NrUHJpc21hSW5zdGFuY2UuJGNvbm5lY3QubW9ja1JlamVjdGVkVmFsdWUoZXJyb3IpXG5cbiAgICAgIGF3YWl0IGV4cGVjdChEYXRhYmFzZVNlcnZpY2UuY29ubmVjdCgpKS5yZWplY3RzLnRvVGhyb3coJ0Nvbm5lY3Rpb24gZmFpbGVkJylcbiAgICAgIGV4cGVjdChjb25zb2xlU3B5LmVycm9yKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgn4p2MIERhdGFiYXNlIGNvbm5lY3Rpb24gZmFpbGVkOicsIGVycm9yKVxuICAgIH0pXG4gIH0pXG5cbiAgZGVzY3JpYmUoJ2Rpc2Nvbm5lY3QnLCAoKSA9PiB7XG4gICAgaXQoJ+W6lOivpeaIkOWKn+aWreW8gOaVsOaNruW6k+i/nuaOpScsIGFzeW5jICgpID0+IHtcbiAgICAgIG1vY2tQcmlzbWFJbnN0YW5jZS4kZGlzY29ubmVjdC5tb2NrUmVzb2x2ZWRWYWx1ZSh1bmRlZmluZWQpXG5cbiAgICAgIGF3YWl0IERhdGFiYXNlU2VydmljZS5kaXNjb25uZWN0KClcblxuICAgICAgZXhwZWN0KG1vY2tQcmlzbWFJbnN0YW5jZS4kZGlzY29ubmVjdCkudG9IYXZlQmVlbkNhbGxlZCgpXG4gICAgICBleHBlY3QoY29uc29sZVNweS5sb2cpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCfinIUgRGF0YWJhc2UgZGlzY29ubmVjdGVkIHN1Y2Nlc3NmdWxseScpXG4gICAgfSlcblxuICAgIGl0KCflupTor6XlpITnkIbmlq3lvIDov57mjqXlpLHotKXnmoTmg4XlhrUnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBlcnJvciA9IG5ldyBFcnJvcignRGlzY29ubmVjdGlvbiBmYWlsZWQnKVxuICAgICAgbW9ja1ByaXNtYUluc3RhbmNlLiRkaXNjb25uZWN0Lm1vY2tSZWplY3RlZFZhbHVlKGVycm9yKVxuXG4gICAgICBhd2FpdCBleHBlY3QoRGF0YWJhc2VTZXJ2aWNlLmRpc2Nvbm5lY3QoKSkucmVqZWN0cy50b1Rocm93KCdEaXNjb25uZWN0aW9uIGZhaWxlZCcpXG4gICAgICBleHBlY3QoY29uc29sZVNweS5lcnJvcikudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ+KdjCBEYXRhYmFzZSBkaXNjb25uZWN0aW9uIGZhaWxlZDonLCBlcnJvcilcbiAgICB9KVxuICB9KVxuXG4gIGRlc2NyaWJlKCdoZWFsdGhDaGVjaycsICgpID0+IHtcbiAgICBpdCgn5bqU6K+l5Zyo5pWw5o2u5bqT5YGl5bq35pe26L+U5ZuedHJ1ZScsIGFzeW5jICgpID0+IHtcbiAgICAgIG1vY2tQcmlzbWFJbnN0YW5jZS4kcXVlcnlSYXcubW9ja1Jlc29sdmVkVmFsdWUoW3sgJzEnOiAxIH1dKVxuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBEYXRhYmFzZVNlcnZpY2UuaGVhbHRoQ2hlY2soKVxuXG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlKHRydWUpXG4gICAgICBleHBlY3QobW9ja1ByaXNtYUluc3RhbmNlLiRxdWVyeVJhdykudG9IYXZlQmVlbkNhbGxlZCgpXG4gICAgfSlcblxuICAgIGl0KCflupTor6XlnKjmlbDmja7lupPkuI3lgaXlurfml7bov5Tlm55mYWxzZScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGVycm9yID0gbmV3IEVycm9yKCdIZWFsdGggY2hlY2sgZmFpbGVkJylcbiAgICAgIG1vY2tQcmlzbWFJbnN0YW5jZS4kcXVlcnlSYXcubW9ja1JlamVjdGVkVmFsdWUoZXJyb3IpXG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IERhdGFiYXNlU2VydmljZS5oZWFsdGhDaGVjaygpXG5cbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmUoZmFsc2UpXG4gICAgICBleHBlY3QoY29uc29sZVNweS5lcnJvcikudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ+KdjCBEYXRhYmFzZSBoZWFsdGggY2hlY2sgZmFpbGVkOicsIGVycm9yKVxuICAgIH0pXG4gIH0pXG5cbiAgZGVzY3JpYmUoJ3J1blRyYW5zYWN0aW9uJywgKCkgPT4ge1xuICAgIGl0KCflupTor6XmiJDlip/miafooYzkuovliqEnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBtb2NrQ2FsbGJhY2sgPSBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoJ3RyYW5zYWN0aW9uIHJlc3VsdCcpXG4gICAgICBtb2NrUHJpc21hSW5zdGFuY2UuJHRyYW5zYWN0aW9uLm1vY2tJbXBsZW1lbnRhdGlvbigoY2FsbGJhY2spID0+IGNhbGxiYWNrKG1vY2tQcmlzbWFJbnN0YW5jZSkpXG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IERhdGFiYXNlU2VydmljZS5ydW5UcmFuc2FjdGlvbihtb2NrQ2FsbGJhY2spXG5cbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmUoJ3RyYW5zYWN0aW9uIHJlc3VsdCcpXG4gICAgICBleHBlY3QobW9ja1ByaXNtYUluc3RhbmNlLiR0cmFuc2FjdGlvbikudG9IYXZlQmVlbkNhbGxlZCgpXG4gICAgICBleHBlY3QobW9ja0NhbGxiYWNrKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChtb2NrUHJpc21hSW5zdGFuY2UpXG4gICAgfSlcblxuICAgIGl0KCflupTor6XlpITnkIbkuovliqHmiafooYzlpLHotKXnmoTmg4XlhrUnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBlcnJvciA9IG5ldyBFcnJvcignVHJhbnNhY3Rpb24gZmFpbGVkJylcbiAgICAgIGNvbnN0IG1vY2tDYWxsYmFjayA9IGplc3QuZm4oKS5tb2NrUmVqZWN0ZWRWYWx1ZShlcnJvcilcbiAgICAgIG1vY2tQcmlzbWFJbnN0YW5jZS4kdHJhbnNhY3Rpb24ubW9ja0ltcGxlbWVudGF0aW9uKChjYWxsYmFjaykgPT4gY2FsbGJhY2sobW9ja1ByaXNtYUluc3RhbmNlKSlcblxuICAgICAgYXdhaXQgZXhwZWN0KERhdGFiYXNlU2VydmljZS5ydW5UcmFuc2FjdGlvbihtb2NrQ2FsbGJhY2spKS5yZWplY3RzLnRvVGhyb3coJ1RyYW5zYWN0aW9uIGZhaWxlZCcpXG4gICAgfSlcbiAgfSlcblxuICBkZXNjcmliZSgnY2xlYW51cCcsICgpID0+IHtcbiAgICBpdCgn5bqU6K+l6LCD55SoZGlzY29ubmVjdOaWueazlScsIGFzeW5jICgpID0+IHtcbiAgICAgIG1vY2tQcmlzbWFJbnN0YW5jZS4kZGlzY29ubmVjdC5tb2NrUmVzb2x2ZWRWYWx1ZSh1bmRlZmluZWQpXG5cbiAgICAgIGF3YWl0IGNsZWFudXAoKVxuXG4gICAgICBleHBlY3QobW9ja1ByaXNtYUluc3RhbmNlLiRkaXNjb25uZWN0KS50b0hhdmVCZWVuQ2FsbGVkKClcbiAgICB9KVxuICB9KVxuXG4gIGRlc2NyaWJlKCdwcmlzbWEgZXhwb3J0JywgKCkgPT4ge1xuICAgIGl0KCflupTor6Xlr7zlh7pwcmlzbWHlrp7kvosnLCAoKSA9PiB7XG4gICAgICBleHBlY3QocHJpc21hKS50b0JlRGVmaW5lZCgpXG4gICAgICBleHBlY3QocHJpc21hKS50b0JlKERhdGFiYXNlU2VydmljZS5nZXRJbnN0YW5jZSgpKVxuICAgIH0pXG4gIH0pXG59KVxuXG4vLyDmtYvor5Xov5vnqIvkuovku7bnm5HlkKzlmahcbmRlc2NyaWJlKCdQcm9jZXNzIEV2ZW50IExpc3RlbmVycycsICgpID0+IHtcbiAgbGV0IG9yaWdpbmFsUHJvY2VzczogTm9kZUpTLlByb2Nlc3NcblxuICBiZWZvcmVBbGwoKCkgPT4ge1xuICAgIG9yaWdpbmFsUHJvY2VzcyA9IGdsb2JhbC5wcm9jZXNzXG4gIH0pXG5cbiAgYWZ0ZXJBbGwoKCkgPT4ge1xuICAgIGdsb2JhbC5wcm9jZXNzID0gb3JpZ2luYWxQcm9jZXNzXG4gIH0pXG5cbiAgaXQoJ+W6lOivpeazqOWGjOi/m+eoi+mAgOWHuuS6i+S7tuebkeWQrOWZqCcsICgpID0+IHtcbiAgICBjb25zdCBtb2NrUHJvY2VzcyA9IHtcbiAgICAgIG9uOiBqZXN0LmZuKCksXG4gICAgfSBhcyBhbnlcblxuICAgIGdsb2JhbC5wcm9jZXNzID0gbW9ja1Byb2Nlc3NcblxuICAgIC8vIOmHjeaWsOWvvOWFpeaooeWdl+S7peinpuWPkeS6i+S7tuebkeWQrOWZqOazqOWGjFxuICAgIGplc3QucmVzZXRNb2R1bGVzKClcbiAgICByZXF1aXJlKCdAL2xpYi9kYXRhYmFzZS9pbmRleCcpXG5cbiAgICBleHBlY3QobW9ja1Byb2Nlc3Mub24pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCdiZWZvcmVFeGl0JywgZXhwZWN0LmFueShGdW5jdGlvbikpXG4gICAgZXhwZWN0KG1vY2tQcm9jZXNzLm9uKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgnU0lHSU5UJywgZXhwZWN0LmFueShGdW5jdGlvbikpXG4gICAgZXhwZWN0KG1vY2tQcm9jZXNzLm9uKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgnU0lHVEVSTScsIGV4cGVjdC5hbnkoRnVuY3Rpb24pKVxuICB9KVxufSkiXSwidmVyc2lvbiI6M30=